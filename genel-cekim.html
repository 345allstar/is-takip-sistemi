<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Genel Çekim Takip - ÜçDörtBeş All Star</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; }
    .searchable-select-container { position: relative; }
    #table-container { max-height: 800px; overflow-y: auto; }
    .searchable-select-dropdown { position: absolute; top: 100%; left: 0; right: 0; z-index: 50; max-height: 200px; overflow-y: auto; }
    .pagination-button { padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; background-color: white; color: #374151; border-radius: 0.375rem; cursor: pointer; transition: all 0.2s; }
    .pagination-button:hover:not(:disabled) { background-color: #f3f4f6; }
    .pagination-button.active { background-color: #4f46e5; color: white; border-color: #4f46e5; }
    .pagination-button:disabled { cursor: not-allowed; opacity: 0.5; }
    .notification { position: fixed; top: 1.25rem; right: 1.25rem; padding: 1rem; border-radius: 0.5rem; color: white; display: flex; align-items: center; gap: 0.75rem; z-index: 1000; opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
    .notification.show { opacity: 1; transform: translateX(0); }
    .notification.success { background-color: #22c55e; }
    .notification.error { background-color: #ef4444; }
    .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; }
    .form-input-base { margin-top: 0.25rem; width: 100%; padding: 0.5rem 0.75rem; background-color: #f9fafb; border: 1px solid #d1d5db; border-radius: 0.5rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); color: #111827; }
    .form-input-base:focus-within, .form-input-base:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 1px #6366f1; }
    .status-badge { display: inline-block; padding: 0.25rem 0.6rem; border-radius: 9999px; font-weight: 500; font-size: 0.7rem; }
    .status-sirada { background-color: #f3f4f6; color: #4b5563; }
    .status-kurguda { background-color: #dbeafe; color: #1d4ed8; }
    .status-tamamlandi { background-color: #dcfce7; color: #166534; }
    .status-revize { background-color: #fee2e2; color: #991b1b; }
    .group-child { display: none; }
    .group-master td { background-color: #f9fafb; }
    .group-toggle-icon { cursor: pointer; transition: transform 0.2s ease-in-out; display: inline-block; }
    .group-toggle-icon.expanded { transform: rotate(180deg); }
    .group-count-badge { background-color: #e0e7ff; color: #4338ca; padding: 2px 6px; border-radius: 8px; font-size: 0.7rem; font-weight: 500; margin-left: 8px; }
    #cekim-tablosu-body tr.satir-secili { outline: 2px solid #ef4444; outline-offset: -2px; }
  </style>
</head>
<body class="bg-slate-50 text-gray-800">

  <div id="notification-container"></div>

  <div class="min-h-screen flex flex-col">
    <header class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-40">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <a href="index.html" class="flex items-center space-x-2">
            <span class="text-xl font-bold bg-indigo-600 text-white px-2 py-1 rounded-lg">ÜDB</span>
            <span class="text-lg font-semibold text-gray-700">All Star İş Takip Programı</span>
          </a>
        </div>
      </div>
    </header>

    <main class="flex-grow p-4 md:p-6">
      <div class="space-y-8">
        <div id="form-container" class="bg-white rounded-xl shadow-lg border border-gray-200/80">
          <button class="collapsible-trigger w-full p-5 text-left font-bold text-lg text-indigo-700 flex justify-between items-center hover:bg-gray-50 rounded-t-xl" data-target="cekim-ekle-form">
            <span id="form-title" class="flex items-center"><i class="fas fa-plus-circle mr-3 text-indigo-500"></i>Çekim Ekle</span>
            <i class="fas fa-chevron-down transition-transform duration-300"></i>
          </button>
          <div id="cekim-ekle-form" class="collapsible-content">
            <div class="p-6 border-t border-gray-200">
              <form id="cek-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-6">
                <input type="hidden" id="editing-row-id" name="id">
                <div><label class="form-label">Çekim Tarihi</label><input name="cekimTarihi" type="date" class="form-input-base"></div>
                <div>
                  <label class="form-label">Sınav Türü</label>
                  <select name="sinavTuru" id="sinav-turu-select" class="searchable-select">
                    <option value="">Seçiniz...</option>
                    <option value="TYT">TYT</option>
                    <option value="AYT">AYT</option>
                    <option value="LGS">LGS</option>
                  </select>
                </div>
                <div>
                  <label class="form-label">Anlatım Türü</label>
                  <select name="anlatimTuru" class="searchable-select" id="anlatim-turu-select">
                    <option value="">Seçiniz...</option>
                    <option>GGÇK</option><option>SORU PRATİĞİ</option><option>TABLET ANLATIM</option><option>AKILLI TAHTA ANLATIM</option><option>ÖZET ANLATIM</option><option>DERECE ANLATIM</option><option>EĞLENCELİ ANLATIM</option><option>İSPATLI ANLATIM</option><option>SÜREÇ İZLEME SINAVI</option><option>ENDENEME</option><option>TÜRKİYE GENELİ DENEME</option><option>TIPKI PROVA</option>
                  </select>
                </div>
                <div><label class="form-label">Video Kodu</label><input name="videoKodu" type="text" placeholder="Video kodunu girin..." class="form-input-base"></div>
                <div>
                  <label class="form-label">Branş</label>
                  <select name="brans" id="brans-select" class="searchable-select" disabled><option value="">Önce sınav türü seçiniz...</option></select>
                </div>
                <div>
                  <label class="form-label">Ünite</label>
                  <select name="unite" id="unite-select" class="searchable-select" disabled><option value="">Önce branş seçiniz...</option></select>
                </div>
                <div>
                  <label class="form-label">Bölüm</label>
                  <select name="bolum" class="searchable-select">
                    <option value="">Seçiniz...</option>
                    <option>1.BÖLÜM</option><option>2. BÖLÜM</option><option>3. BÖLÜM</option><option>4. BÖLÜM</option><option>5. BÖLÜM</option>
                    <option>6. BÖLÜM</option><option>7. BÖLÜM</option><option>8. BÖLÜM</option><option>9. BÖLÜM</option><option>10. BÖLÜM</option>
                  </select>
                </div>
                <div>
                  <label class="form-label">Ders</label>
                  <select name="ders" class="searchable-select">
                    <option value="">Seçiniz...</option>
                    <option>1. DERS</option><option>2. DERS</option><option>3. DERS</option><option>4. DERS</option><option>5. DERS</option>
                    <option>6. DERS</option><option>7. DERS</option><option>8. DERS</option><option>9. DERS</option><option>10. DERS</option>
                  </select>
                </div>
                <div><label class="form-label">Test Adı</label>
                  <input name="testAdi" type="text" list="test-adi-list" placeholder="Test adını yazın..." class="form-input-base">
                  <datalist id="test-adi-list"></datalist>
                </div>
                <div><label class="form-label">Soru Sayısı</label>
                  <input name="soruSayisi" type="number" min="1" max="50" placeholder="Örn: 8" class="form-input-base">
                </div>
                <div><label class="form-label">Anlatıcı Öğretmen</label>
                  <select name="anlaticiOgretmen" class="searchable-select">
                    <option value="">Seçiniz...</option>
                  </select>
                </div>
                <div>
                  <label class="form-label">Yüklenme Durumu</label>
                  <select name="yuklenmeDurumu" class="searchable-select">
                    <option value="">Seçiniz...</option>
                    <option value="Yüklenmeye Hazır">Yüklenmeye Hazır</option>
                    <option value="Kontrol Ediliyor">Kontrol Ediliyor</option>
                    <option value="Kontrol Bekliyor">Kontrol Bekliyor</option>
                    <option value="Teknik Düzeltmede">Teknik Düzeltmede</option>
                    <option value="Akademik İzlemede">Akademik İzlemede</option>
                  </select>
                </div>
                <div class="lg:col-span-3"><label class="form-label">Not</label><textarea name="not" rows="2" class="form-input-base" placeholder="Eklemek istediğiniz notlar..."></textarea></div>
                <div class="md:col-span-2 lg:col-span-3 text-right pt-4">
                  <button id="submit-button" type="submit" class="inline-flex items-center justify-center py-2 px-6 border border-transparent shadow-lg text-sm font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700">
                    <i id="submit-icon" class="fas fa-check mr-2"></i><span id="submit-text">Kaydet</span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200/80">
          <button class="collapsible-trigger w-full p-5 text-left font-bold text-lg text-indigo-700 flex justify-between items-center hover:bg-gray-50 rounded-t-xl" data-target="liste-tablo-alani">
            <span class="flex items-center"><i class="fas fa-list-ul mr-3 text-indigo-500"></i>Çekim Listesi</span>
            <i class="fas fa-chevron-down transition-transform duration-300"></i>
          </button>
          <div id="liste-tablo-alani" class="collapsible-content">
            <div class="p-2 sm:p-4 border-t border-gray-200">
              <div id="table-container" class="overflow-x-auto">
                <table id="cekim-tablosu" class="min-w-full border-collapse">
                  <thead class="bg-gray-100" style="font-size: 0.7rem;">
                    <tr>
                      <th class="p-2 border">Çekim Tarihi</th>
                      <th class="p-2 border">Sınav Türü</th>
                      <th class="p-2 border">Anlatım Türü</th>
                      <th class="p-2 border">Video Kodu</th>
                      <th class="p-2 border">Branş</th>
                      <th class="p-2 border">Ünite</th>
                      <th class="p-2 border">Bölüm</th>
                      <th class="p-2 border">Ders</th>
                      <th class="p-2 border">Test Adı</th>
                      <th class="p-2 border">Soru Sayısı</th>
                      <th class="p-2 border">Not</th>
                      <th class="p-2 border">Anlatıcı Öğretmen</th>
                      <th class="p-2 border">Yönetmen</th>
                      <th class="p-2 border">Akademik Dinleyici</th>
                      <th class="p-2 border">Kurgu Başlama</th>
                      <th class="p-2 border">Kurgu Bitiş</th>
                      <th class="p-2 border">Kurgu Operatörü</th>
                      <th class="p-2 border">Kurgu Durumu</th>
                      <th class="p-2 border">Teknik Ekip Üyesi</th>
                      <th class="p-2 border">Teknik İzleme Tarihi</th>
                      <th class="p-2 border">Akademik İzl. Öğretmeni</th>
                      <th class="p-2 border">Akademik İzl. Tarihi</th>
                      <th class="p-2 border">Yüklenme Durumu</th>
                      <th class="p-2 border">Yazılım Yükleme Üyesi</th>
                      <th class="p-2 border">Yazılıma Yükleme Tarihi</th>
                      <th class="p-2 border">Yükleme Durumu</th>
                      <th class="p-2 border">İşlemler</th>
                    </tr>
                    <tr>
                      <td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
<td class="p-1 border"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 rounded"></td>
                    </tr>
                  </thead>
                  <tbody id="cekim-tablosu-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
              </div>
              <div class="flex items-center justify-between mt-4 p-2 border-t">
                <span id="record-count" class="text-sm text-gray-600"></span>
                <div id="pagination-controls" class="flex items-center space-x-1"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const SUPABASE_URL = 'https://nwxgigtsadesqjgflblr.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53eGdpZ3RzYWRlc3FqZ2ZsYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTc0NjIsImV4cCI6MjA3NTYzMzQ2Mn0.fXEsCigwmLvQBq8_X-s_AbjJ1maioProPjPh-nNn1f4';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentPage = 1;
  const rowsPerPage = 20;
  let allCekimler = [];

  const anlaticiOgretmenler = ['Ali Saçan','Altuğ Güneş','Anıl Gül','Bayram Meral','Betül Büyükkalaycı','Buğra Arslan','Burak Onay','Büşra Altınok','Cebrail Karaoğlan','Celal Gündüz'];
  const testAdlari = ['LGS TADINDA 1','LGS TADINDA 2','SINAV TADINDA 1','YENİ NESLE GEÇİŞ 1','MODULE TEST 1','FINAL TEST'];

  const bransListeleri = {
    'TYT': ['TYT TÜRKÇE','TYT MATEMATİK','TYT FİZİK','TYT KİMYA','TYT BİYOLOJİ','TYT COĞRAFYA','TYT DİN KÜLTÜRÜ','TYT-AYT GEOMETRİ','TYT-AYT TARİH','TYT-AYT FELSEFE'],
    'AYT': ['AYT EDEBİYAT','AYT MATEMATİK','AYT FİZİK','AYT KİMYA','AYT BİYOLOJİ','AYT COĞRAFYA','AYT SOSYOLOJİ-PSİKOLOJİ-MANTIK','TYT-AYT GEOMETRİ','TYT-AYT TARİH','TYT-AYT FELSEFE'],
    'LGS': ['LGS TÜRKÇE','LGS MATEMATİK','LGS FEN BİLİMLERİ','LGS İNKILAP TARİHİ','LGS İNGİLİZCE','LGS DİN KÜLTÜRÜ']
  };

  const uniteListeleri = {
    'TYT MATEMATİK': ['TEMEL KAVRAMLAR','BÖLME BÖLÜNEBİLME','RASYONEL SAYILAR'],
    'AYT MATEMATİK': ['FONKSİYONLAR','POLİNOMLAR','TÜREV'],
    'LGS MATEMATİK': ['ÇARPANLAR VE KATLAR','ÜSLÜ İFADELER']
  };

  const sinavTuruSelect = document.getElementById('sinav-turu-select');
  const bransSelect = document.getElementById('brans-select');
  const uniteSelect = document.getElementById('unite-select');
  const cekForm = document.getElementById('cek-form');
  const tableBody = document.getElementById('cekim-tablosu-body');
  const recordCountEl = document.getElementById('record-count');
  const paginationControlsEl = document.getElementById('pagination-controls');

  function showNotification(message, type='success') {
    const container = document.getElementById('notification-container'); if (!container) return;
    const el = document.createElement('div');
    el.className = `notification ${type}`;
    el.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle':'fa-times-circle'}"></i><span>${message}</span>`;
    container.appendChild(el); requestAnimationFrame(()=>el.classList.add('show'));
    setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),500); },3000);
  }

  const formatDate = (dateString) => {
    if (!dateString) return '';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return '';
    return `${String(date.getDate()).padStart(2,'0')}/${String(date.getMonth()+1).padStart(2,'0')}/${date.getFullYear()}`;
  };

  const normalize = s => (s||'').toString().trim().replace(/\s+/g,' ').toLowerCase();
  function setSelectByValueOrText(selectEl, value) {
    const target = normalize(value);
    const option = Array.from(selectEl.options).find(opt => normalize(opt.value||opt.textContent)===target);
    if (option) { selectEl.value = option.value || option.textContent; }
    (selectEl.updateDropdown ? selectEl.updateDropdown() : 0);
    selectEl.dispatchEvent(new Event('change'));
  }

  function createSearchableDropdown(selectElement) {
    const container = document.createElement('div');
    container.className = 'searchable-select-container relative';
    selectElement.parentNode.insertBefore(container, selectElement);
    selectElement.style.display = 'none';
    container.appendChild(selectElement);

    const displayButton = document.createElement('button');
    displayButton.type = 'button';
    displayButton.className = 'form-input-base text-left flex justify-between items-center';
    const displaySpan = document.createElement('span');
    displaySpan.className = 'truncate';
    displayButton.appendChild(displaySpan);
    const icon = document.createElement('i');
    icon.className = 'fas fa-chevron-down text-gray-400';
    displayButton.appendChild(icon);
    container.appendChild(displayButton);

    const dropdown = document.createElement('div');
    dropdown.className = 'searchable-select-dropdown hidden bg-white border border-gray-300 rounded-lg mt-1 shadow-lg';
    const searchInput = document.createElement('input');
    searchInput.type = 'text'; searchInput.placeholder = 'Ara...';
    searchInput.className = 'block w-full p-2 border-b border-gray-200 focus:outline-none';
    dropdown.appendChild(searchInput);
    const optionsList = document.createElement('div');
    optionsList.className = 'p-1';
    dropdown.appendChild(optionsList);
    container.appendChild(dropdown);

    const updateOptions = () => {
      optionsList.innerHTML = '';
      Array.from(selectElement.options).forEach(option => {
        if (option.value === "" && (option.textContent.includes('Seçiniz') || option.textContent.includes('Önce'))) return;
        const optionDiv = document.createElement('div');
        optionDiv.textContent = option.textContent;
        optionDiv.dataset.value = option.value;
        optionDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 rounded text-sm';
        optionDiv.addEventListener('click', () => {
          selectElement.value = option.value;
          displaySpan.textContent = option.textContent;
          displaySpan.classList.remove('text-gray-400');
          dropdown.classList.add('hidden');
          selectElement.dispatchEvent(new Event('change'));
        });
        optionsList.appendChild(optionDiv);
      });
      const selectedOption = selectElement.querySelector(`option[value="${selectElement.value}"]`) || selectElement.options[0];
      if (selectedOption) {
        displaySpan.textContent = selectedOption.textContent;
        if (selectedOption.value === "" || selectElement.disabled) displaySpan.classList.add('text-gray-400');
        else displaySpan.classList.remove('text-gray-400');
      }
    };
    searchInput.addEventListener('input', () => {
      const filter = searchInput.value.toLowerCase();
      optionsList.querySelectorAll('div').forEach(optionDiv => {
        const text = optionDiv.textContent.toLowerCase();
        optionDiv.style.display = text.includes(filter) ? '' : 'none';
      });
    });
    displayButton.addEventListener('click', (e) => {
      e.stopPropagation();
      if (selectElement.disabled) return;
      document.querySelectorAll('.searchable-select-dropdown').forEach(d => { if (d !== dropdown) d.classList.add('hidden'); });
      dropdown.classList.toggle('hidden');
      if (!dropdown.classList.contains('hidden')) {
        searchInput.value = '';
        searchInput.dispatchEvent(new Event('input'));
        searchInput.focus();
      }
    });
    selectElement.updateDropdown = updateOptions;
    updateOptions();
  }

  document.querySelectorAll('.searchable-select').forEach(createSearchableDropdown);
  document.addEventListener('click', () => { document.querySelectorAll('.searchable-select-dropdown').forEach(d => d.classList.add('hidden')); });

  const updateSelectDisplay = (selectElement) => { if (selectElement && selectElement.updateDropdown) selectElement.updateDropdown(); };

  sinavTuruSelect.addEventListener('change', () => {
    const branslar = bransListeleri[sinavTuruSelect.value] || [];
    bransSelect.innerHTML = '<option value="" selected>Seçiniz...</option>';
    uniteSelect.innerHTML = '<option value="" selected>Önce branş seçiniz...</option>';
    bransSelect.disabled = branslar.length === 0;
    uniteSelect.disabled = true;
    branslar.forEach(brans => {
      const opt = document.createElement('option'); opt.value = brans; opt.textContent = brans; bransSelect.appendChild(opt);
    });
    updateSelectDisplay(bransSelect); updateSelectDisplay(uniteSelect);
  });

  bransSelect.addEventListener('change', () => {
    const uniteler = uniteListeleri[bransSelect.value] || [];
    uniteSelect.innerHTML = '<option value="" selected>Seçiniz...</option>';
    uniteSelect.disabled = uniteler.length === 0;
    uniteler.forEach(unite => {
      const opt = document.createElement('option'); opt.value = unite; opt.textContent = unite; uniteSelect.appendChild(opt);
    });
    updateSelectDisplay(uniteSelect);
  });

  async function loadCekimlerFromSupabase() {
    const { data, error } = await supabaseClient
      .from('cekimler')
      .select('*')
      .order('cekimTarihi', { ascending: false })
      .range(0, 999);
    if (error) { console.error(error); showNotification('Veriler yüklenirken hata oluştu.', 'error'); allCekimler = []; }
    else { allCekimler = data || []; }
  }

  function renderFilteredData() {
    const filtered = allCekimler;
    tableBody.innerHTML = '';
    filtered.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="p-1 border">${formatDate(row.cekimTarihi)}</td>
        <td class="p-1 border">${row.sinavTuru||''}</td>
        <td class="p-1 border">${row.anlatimTuru||''}</td>
        <td class="p-1 border">${row.videoKodu||''}</td>
        <td class="p-1 border">${row.brans||''}</td>
        <td class="p-1 border">${row.unite||''}</td>
        <td class="p-1 border">${row.bolum||''}</td>
        <td class="p-1 border">${row.ders||''}</td>
        <td class="p-1 border">${row.testAdi||''}</td>
        <td class="p-1 border">${row.soruSayisi||''}</td>
        <td class="p-1 border">${row.not||''}</td>
        <td class="p-1 border">${row.anlaticiOgretmen||''}</td>
        <td class="p-1 border">${row.yonetmen||''}</td>
        <td class="p-1 border">${row.akademikDinleyici||''}</td>
        <td class="p-1 border">${formatDate(row.kurguBaslamaTarihi)}</td>
        <td class="p-1 border">${formatDate(row.kurguBitisTarihi)}</td>
        <td class="p-1 border">${row.kurguOperatoru||''}</td>
        <td class="p-1 border">${row.kurguDurumu||''}</td>
        <td class="p-1 border">${row.teknikEkipUyesi||''}</td>
        <td class="p-1 border">${formatDate(row.teknikIzlemeTarihi)}</td>
        <td class="p-1 border">${row.akademikIzlemeOgretmeni||''}</td>
        <td class="p-1 border">${formatDate(row.akademikIzlemeTarihi)}</td>
        <td class="p-1 border">${row.yuklenmeDurumu||''}</td>
        <td class="p-1 border">${row.yazilimYuklemeUyesi||''}</td>
        <td class="p-1 border">${formatDate(row.yazilimaYuklemeTarihi)}</td>
        <td class="p-1 border">${row.yuklemeDurumu||''}</td>
        <td class="p-1 border">
          <button class="duzenle px-2 py-1 bg-indigo-600 text-white rounded" data-id="${row.id}">Düzenle</button>
        </td>`;
      tableBody.appendChild(tr);
    });
    recordCountEl.textContent = `Toplam ${filtered.length} kayıt bulundu.`;
  }

  async function renderTable() { await loadCekimlerFromSupabase(); renderFilteredData(); }

  cekForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(cekForm);
    const data = Object.fromEntries(formData.entries());
    const editingId = data.id; if (!editingId) delete data.id;
    Object.keys(data).forEach(k => { if (k.toLowerCase().includes('tarih') && !data[k]) data[k] = null; });
    data.soruSayisi = data.soruSayisi ? parseInt(data.soruSayisi, 10) : null;

    const { error } = editingId
      ? await supabaseClient.from('cekimler').update(data).eq('id', editingId)
      : await supabaseClient.from('cekimler').insert([data]);

    if (error) showNotification((editingId?'Güncelleme':'Kayıt') + ' hatası: ' + error.message, 'error');
    else showNotification(editingId ? 'Kayıt güncellendi!' : 'Kayıt eklendi!');

    await renderTable();
    cekForm.reset();
    document.getElementById('editing-row-id').value = '';
    document.getElementById('form-title').innerHTML = '<i class="fas fa-plus-circle mr-3 text-indigo-500"></i>Çekim Ekle';
    document.getElementById('submit-text').textContent = 'Kaydet';
    document.getElementById('submit-icon').className = 'fas fa-check mr-2';
    cekForm.querySelectorAll('select').forEach(el => el.updateDropdown && el.updateDropdown());
  });

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.duzenle');
    if (!btn) return;
    const id = btn.dataset.id;
    const cekim = allCekimler.find(c => String(c.id) === String(id));
    if (!cekim) return;

    Object.keys(cekim).forEach(key => {
      const el = cekForm.elements[key];
      if (el && el.tagName !== 'SELECT') el.value = cekim[key] ?? '';
    });

    if (cekim.sinavTuru) setSelectByValueOrText(sinavTuruSelect, cekim.sinavTuru); else { sinavTuruSelect.value = ''; sinavTuruSelect.updateDropdown && sinavTuruSelect.updateDropdown(); sinavTuruSelect.dispatchEvent(new Event('change')); }
    if (cekim.brans) setTimeout(()=> setSelectByValueOrText(bransSelect, cekim.brans), 60);
    if (cekim.unite) setTimeout(()=> setSelectByValueOrText(uniteSelect, cekim.unite), 120);
    const anlatimSelect = document.getElementById('anlatim-turu-select'); if (anlatimSelect) setSelectByValueOrText(anlatimSelect, cekim.anlatimTuru || '');
    ['bolum','ders','anlaticiOgretmen','yuklenmeDurumu'].forEach(name => { const el = cekForm.elements[name]; if (el) setSelectByValueOrText(el, cekim[name] || ''); });

    document.getElementById('editing-row-id').value = id;
    document.getElementById('form-title').innerHTML = '<i class="fas fa-edit mr-3 text-indigo-500"></i>Kaydı Düzenle';
    document.getElementById('submit-text').textContent = 'Güncelle';
    document.getElementById('submit-icon').className = 'fas fa-sync-alt mr-2';

    const formContent = document.getElementById('cekim-ekle-form');
    if (!formContent.style.maxHeight || formContent.style.maxHeight === '0px') {
      formContent.parentElement.querySelector('.collapsible-trigger').click();
    }
    document.getElementById('form-container').scrollIntoView({ behavior: 'smooth' });
  });

  function initializePage() {
    document.querySelectorAll('.collapsible-trigger').forEach(trigger => {
      const content = document.getElementById(trigger.dataset.target);
      const icon = trigger.querySelector('i.fas');
      if (content && icon) {
        setTimeout(() => { content.style.maxHeight = content.scrollHeight + 'px'; icon.classList.add('rotate-180'); }, 200);
      }
    });

    const anlaticiSelect = document.querySelector('select[name="anlaticiOgretmen"]');
    anlaticiOgretmenler.sort().forEach(o => { const opt=document.createElement('option'); opt.value=o; opt.textContent=o; anlaticiSelect.appendChild(opt); });
    anlaticiSelect.updateDropdown && anlaticiSelect.updateDropdown();

    const testDatalist = document.getElementById('test-adi-list');
    testAdlari.forEach(t => { const opt=document.createElement('option'); opt.value=t; testDatalist.appendChild(opt); });

    renderTable();
  }

  initializePage();
});
</script>
</body>
</html>
