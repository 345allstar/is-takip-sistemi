<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>İstatistikler | All Star İş Takip Programı</title>

  <!-- Tailwind (projendeki gibi CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome (ikonlar için) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    /* Rozetler ve tablo görünümü */
    .badge{display:inline-block;padding:.22rem .55rem;border-radius:9999px;font-weight:700;font-size:.75rem;line-height:1}
    .badge-ok{background:#bbf7d0;color:#166534}
    .badge-warn{background:#fef9c3;color:#854d0e}
    .badge-info{background:#dbeafe;color:#1d4ed8}
    .badge-danger{background:#fee2e2;color:#991b1b}
    .badge-purple{background:#ede9fe;color:#5b21b6}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace}
    .list-chip{display:inline-flex;align-items:center;gap:.25rem;margin:.15rem .35rem .15rem 0}
    .tbl th,.tbl td{border-bottom:1px solid #eef2f7}
    .sticky-head thead th{position:sticky;top:0;background:#f8fafc;z-index:1}
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- HEADER -->
  <header class="bg-white shadow-sm">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center gap-3">
      <a href="index.html" class="flex items-center gap-2">
        <img src="logo.png" alt="ÜçDörtBeş All Star" class="h-10 w-auto"/>
        <span class="text-xl font-semibold">İstatistikler</span>
      </a>
      <a href="index.html" class="ml-auto text-indigo-600 hover:text-indigo-800"><i class="fa-solid fa-house"></i> Ana sayfa</a>
    </div>
  </header>

  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- 6 sabit branş butonu -->
    <div id="branButtons" class="flex flex-wrap gap-2"></div>

    <!-- Kart + Tablo -->
    <div class="mt-4 bg-white rounded-2xl shadow p-4">
      <div class="flex items-center justify-between">
        <h2 id="panelTitle" class="text-lg font-semibold">Branş seçiniz</h2>
        <div id="rowCount" class="text-sm text-gray-500"></div>
      </div>

      <div class="mt-3 overflow-auto">
        <table class="tbl sticky-head min-w-full text-sm">
          <thead>
            <tr>
              <th class="px-3 py-2 w-48 text-left">Ünite</th>
              <th class="px-3 py-2 w-44 text-left">Bölüm</th>
              <th class="px-3 py-2 text-left">Tabletli Konu Anlatım</th>
              <th class="px-3 py-2 text-left">Özet Anlatım</th>
              <th class="px-3 py-2 text-left">Soru Pratiği</th>
              <th class="px-3 py-2 w-40 text-left">Çekim</th>
              <th class="px-3 py-2 w-44 text-left">Akademik İzleme</th>
              <th class="px-3 py-2 w-40 text-left">Yazılım</th>
            </tr>
          </thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    /* 1) Supabase init — BURAYI DOLDUR */
    const SUPABASE_URL = 'https://nwxgigtsadesqjgflblr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53eGdpZ3RzYWRlc3FqZ2ZsYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTc0NjIsImV4cCI6MjA3NTYzMzQ2Mn0.fXEsCigwmLvQBq8_X-s_AbjJ1maioProPjPh-nNn1f4';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* 2) Branş butonları (sabit) */
    const BRANSLAR = [
      "LGS TÜRKÇE",
      "LGS MATEMATİK",
      "LGS FEN BİLİMLERİ",
      "LGS İNKILAP TARİHİ",
      "LGS DİN KÜLTÜRÜ",
      "LGS İNGİLİZCE"
    ];
    const branEl = document.getElementById('branButtons');

    BRANSLAR.forEach((b, i) => {
      const btn = document.createElement('button');
      btn.className = 'px-3 py-2 rounded-full border bg-white hover:bg-indigo-50 text-sm ' + (i===0 ? 'ring-2 ring-indigo-500' : '');
      btn.textContent = b;
      btn.dataset.bran = b;
      btn.addEventListener('click', () => {
        branEl.querySelectorAll('button').forEach(x=>x.classList.remove('ring-2','ring-indigo-500'));
        btn.classList.add('ring-2','ring-indigo-500');
        loadTable(b);
      });
      branEl.appendChild(btn);
    });

    /* 3) Yardımcılar */
    const safe = s => (s ?? '').toString().trim();
    const tUpper = s => safe(s).toLocaleUpperCase('tr-TR'); // TR büyük harf eşleşmesi

    // Anlatım türü sütunları (PDF'teki düzen)
    const COLS = [
      { key: "TABLET", label: "Tabletli Konu Anlatım", match: t => tUpper(t).includes("TABLET") },
      { key: "OZET",   label: "Özet Anlatım",          match: t => tUpper(t).includes("ÖZET")   },
      { key: "PRATIK", label: "Soru Pratiği",          match: t => tUpper(t).includes("PRAT")   },
    ];

    // Yazılım (yüklenme) rozeti
    const YAZILIM_BADGE = v => {
      switch (v) {
        case "Yüklenmeye Hazır":  return `<span class="badge badge-ok">${v}</span>`;
        case "Kontrol Ediliyor":  return `<span class="badge badge-info">${v}</span>`;
        case "Kontrol Bekliyor":  return `<span class="badge badge-warn">${v}</span>`;
        case "Teknik Düzeltmede": return `<span class="badge badge-danger">${v}</span>`;
        case "Akademik İzlemede": return `<span class="badge badge-purple">${v}</span>`;
        default: return v || "";
      }
    };
    const CEKIM_BADGE = adet => adet > 0
      ? `<span class="badge badge-ok">ÇEKİLDİ (${adet} ders)</span>`
      : `<span class="badge badge-warn">Çekim yok</span>`;

    function dersListesiHTML(items){
      if (!items.length) return '<span class="text-gray-400">—</span>';
      return items.map(it =>
        `<span class="list-chip">
           <span>${safe(it.ders) || 'Ders'}</span>
           ${safe(it.kod) ? `<span class="mono text-xs text-gray-600">(${safe(it.kod)})</span>` : ''}
         </span>`
      ).join('');
    }

    /* 4) Seçilen branşa göre veriyi çek → ÜNİTE → BÖLÜM kırılımında yaz */
    async function loadTable(brans) {
      document.getElementById('panelTitle').textContent = `${brans} — Ünite/Bölüm tablosu`;
      const tbody = document.getElementById('tblBody');
      tbody.innerHTML = `<tr><td class="px-3 py-6 text-gray-500" colspan="8">Yükleniyor…</td></tr>`;

      // Genel Çekim Takipte listelediğin alanlar
      const { data, error } = await supabaseClient
        .from('cekimler')
        .select('id, unite, bolum, ders, videoKodu, anlatimTuru, kurguDurumu, akademikIzlemeYapilabilirligi, yuklenmeDurumu, brans')
        .eq('brans', brans);

      if (error) { console.error(error); tbody.innerHTML = ''; return; }

      // Ünite -> Bölüm -> sütun başına ders listeleri, çekim sayısı ve son durumlar
      const byUnite = new Map();
      data.forEach(row => {
        const u = safe(row.unite);
        const b = safe(row.bolum);

        if (!byUnite.has(u)) byUnite.set(u, new Map());
        const byBolum = byUnite.get(u);
        if (!byBolum.has(b)) byBolum.set(b, { groups: {}, cekimTop: 0, akd: null, yaz: null });

        const node = byBolum.get(b);
        const t = row.anlatimTuru || '';

        const col = COLS.find(c => c.match(t));
        if (col) {
          if (!node.groups[col.key]) node.groups[col.key] = [];
          node.groups[col.key].push({ ders: row.ders, kod: row.videoKodu });
          if (safe(row.videoKodu)) node.cekimTop += 1;
        }
        // En son görülen akademik & yazılım durumlarını yaz (istersen en "kötüsüne" öncelik verecek mantık ekleriz)
        node.akd = row.akademikIzlemeYapilabilirligi ?? node.akd;
        node.yaz = row.yuklenmeDurumu ?? node.yaz;
      });

      // Yaz
      tbody.innerHTML = '';
      let satir = 0;

      [...byUnite.entries()].forEach(([u, bolumMap]) => {
        const bolumEntries = [...bolumMap.entries()];
        bolumEntries.forEach(([b, node], idx) => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50';

          // ÜNİTE (rowspan)
          if (idx === 0) {
            const tdU = document.createElement('td');
            tdU.className = 'px-3 py-2 align-top font-medium';
            tdU.rowSpan = bolumEntries.length;
            tdU.textContent = u || '-';
            tr.appendChild(tdU);
          }

          // BÖLÜM
          tr.innerHTML += `<td class="px-3 py-2 align-top">${b || '-'}</td>`;

          // 3 anlatım türü sütunu
          COLS.forEach(col => {
            const list = node.groups[col.key] || [];
            tr.innerHTML += `<td class="px-3 py-2 align-top">${dersListesiHTML(list)}</td>`;
          });

          // Çekim | Akademik | Yazılım
          tr.innerHTML += `
            <td class="px-3 py-2 align-top">${CEKIM_BADGE(node.cekimTop)}</td>
            <td class="px-3 py-2 align-top">${safe(node.akd)}</td>
            <td class="px-3 py-2 align-top">${YAZILIM_BADGE(safe(node.yaz))}</td>
          `;

          tbody.appendChild(tr);
          satir++;
        });
      });

      document.getElementById('rowCount').textContent = `${satir} satır`;
    }

    // Başlangıç: ilk branş otomatik yüklensin
    loadTable(BRANSLAR[0]);
  </script>
</body>
</html>
