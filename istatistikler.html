<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>İstatistikler</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Compact tablo görünümü */
  .tbl                      { font-size: 12px; }
  .tbl th, .tbl td          { border: 1px solid #e5e7eb; vertical-align: middle; }
  .tbl th                   { background: #f8fafc; font-weight: 600; white-space: nowrap; }
  .tbl .center-cell         { text-align: center; }
  .tbl .unit-col            { min-width: 160px; }
  .tbl .section-col         { min-width: 92px; text-align:center; }
  .teacher-cap              { white-space: nowrap; }
  .teacher-name             { margin-left: .25rem; font-weight: 600; }

  /* Hücre içindeki çoklu satırlar */
  .cell-stack               { display:flex; flex-direction:column; gap:.25rem; }
  .cell-stack .list-row     { display:flex; flex-wrap:wrap; justify-content:center; gap:.25rem; line-height:1.15; }
  .cell-stack .list-row + .list-row { border-top: 1px dashed #e5e7eb; padding-top:.25rem; margin-top:.25rem; }

  /* Rozet/badge stilleri */
  .badge                    { display:inline-block; padding:.15rem .45rem; border-radius:.5rem; background:#eef2ff; color:#3730a3; font-weight:600; }
  .badge.green              { background:#ecfdf5; color:#065f46; }
  .badge.gray               { background:#f3f4f6; color:#374151; }
  .badge.yellow             { background:#fffbeb; color:#92400e; }
  .mono                     { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  /* Satır hover / seçim */
  tbody tr:hover            { background:#fafafa; }
  tbody tr:focus-within,
  tbody tr:focus            { outline:2px solid #f87171; outline-offset:-2px; }
</style>
</head>
<body class="bg-gray-50">
  <header class="px-5 py-4 flex items-center justify-between">
    <h1 class="text-xl font-semibold text-gray-800">İstatistikler</h1>
    <a href="./index.html" class="text-indigo-600 hover:text-indigo-800 text-sm">Ana sayfa</a>
  </header>

  <main class="max-w-[95rem] mx-auto px-4 pb-20">
    <!-- Branş sekmeleri -->
    <div id="branchTabs" class="flex flex-wrap gap-2 mb-4"></div>

    <!-- Tablo sarmalayıcı -->
    <div class="bg-white rounded-xl shadow p-3">
      <h2 id="tableTitle" class="text-sm font-semibold text-gray-700 px-2 mb-3">Branş seçiniz</h2>
      <div class="overflow-x-auto">
        <table id="grid" class="tbl w-full text-[12px]">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
  /*********************************************************************
   * 1) SUPABASE BAĞLANTISI
   *********************************************************************/
  const SUPABASE_URL = 'https://nwxgigtsadesqjgflblr.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53eGdpZ3RzYWRlc3FqZ2ZsYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTc0NjIsImV4cCI6MjA3NTYzMzQ2Mn0.fXEsCigwmLvQBq8_X-s_AbjJ1maioProPjPh-nNn1f4';
  const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /*********************************************************************
   * 2) ALAN HARİTASI — Şemanız farklıysa SADECE BURAYI DÜZENLEYİN
   *********************************************************************/
  const FIELD = {
    branch       : 'brans',
    unit         : 'unite',
    section      : 'bolum',
    lessonLabel  : 'ders',            // "1. DERS" gibi (boş ise biz üretiriz)
    videoShort   : 'videoKodu',       // kısa kod
    videoLong    : 'videoKoduUzun',   // uzun kod (varsa)
    testName     : 'testAdi',         // soru pratiği / gcçk test adı
    teacher      : 'anlaticiOgretmen',
    kind         : 'anlatimTuru',     // "Tabletli Anlatım", "Özet Anlatım", "Soru Pratiği", "GCÇK"

    // Durumlar (çekim/akademik/yükleme)
    statusShoot  : 'cekimDurumu',
    statusAkd    : 'akademikIzlemeDurumu',
    statusLoad   : 'yuklemeDurumu',   // bazı projelerde 'yuklenmeDurumu' olabilir

    // Sık kullanılan sabit değerler
    kindTablet   : 'TABLETLI_ANLATIM',  // veriyi normalize ediyoruz (aşağıda normalizeKind ile)
    kindOzet     : 'OZET_ANLATIM',
    kindPratik   : 'SORU_PRATIGI',
    kindGcck     : 'GCCK'
  };

  // Gelen anlatım adını normalize et (küçük/büyük/aksan farklarını kapat)
  function normalizeKind(v) {
    if (!v) return '';
    const s = String(v).toLocaleLowerCase('tr').trim();
    if (s.includes('tablet')) return FIELD.kindTablet;
    if (s.includes('özet') || s.includes('ozet')) return FIELD.kindOzet;
    if (s.includes('pratik') || s.includes('soru')) return FIELD.kindPratik;
    if (s.includes('gcçk') || s.includes('gcck') || s.includes('geçiş')) return FIELD.kindGcck;
    return s.toUpperCase();
  }

  /*********************************************************************
   * 3) YARDIMCILAR
   *********************************************************************/
  const BRANCHES = [
    'LGS TÜRKÇE', 'LGS MATEMATİK', 'LGS FEN BİLİMLERİ',
    'LGS İNKILAP TARİHİ', 'LGS DİN KÜLTÜRÜ', 'LGS İNGİLİZCE'
  ];

  function badge(txt, color='indigo'){ 
    if(!txt) return '';
    const map = { green:'green', gray:'gray', yellow:'yellow' };
    const cls  = map[color] ? map[color] : '';
    return `<span class="badge ${cls}">${txt}</span>`;
  }
  const safe = v => (v==null || v==='') ? '' : String(v);

  // tek/çok öğretmen isim listesi
  function getTeachers(records, scopeKey){
    const names = Array.from(new Set(
      records
        .filter(r => SCOPE[scopeKey].match(normalizeKind(r[FIELD.kind])))
        .map(r => safe(r[FIELD.teacher]))
        .filter(Boolean)
    ));
    // ÖZET için isim boşsa da bir sütun açabilmek adına '' döndür
    return names.length ? names : [''];
  }

  // hücre: çekim (Video Kodu + ders sayısı)
  function renderCekimList(rows){
    if(!rows.length) return '—';
    const lines = rows.map(r=>{
      const vcode = safe(r[FIELD.videoShort]) || '—';
      const ders  = safe(r[FIELD.lessonLabel]) || '';
      const status= safe(r[FIELD.statusShoot]) || '';
      const sBadge= status ? badge(status,'green') : '';
      const lBadge= vcode  ? badge(vcode,'gray')  : '';
      const dText = ders   ? `<span class="mono">${ders}</span>` : '';
      return `<div class="list-row">${sBadge}${lBadge}${dText}</div>`;
    });
    return `<div class="cell-stack">${lines.join('')}</div>`;
  }
  // hücre: akademik izleme
  function renderAkdList(rows){
    if(!rows.length) return '—';
    const lines = rows.map(r=>{
      const st = safe(r[FIELD.statusAkd]);
      return `<div class="list-row">${ badge(st || '—','green') }</div>`;
    });
    return `<div class="cell-stack">${lines.join('')}</div>`;
  }
  // hücre: yükleme
  function renderYazList(rows){
    if(!rows.length) return '—';
    const lines = rows.map(r=>{
      const st = safe(r[FIELD.statusLoad]);
      return `<div class="list-row">${ badge(st || '—','yellow') }</div>`;
    });
    return `<div class="cell-stack">${lines.join('')}</div>`;
  }

  // Tek öğretmen için 3 hücre döndür (çekim/akd/yükleme).
  function cellsFor(records, scopeKey, teacherName){
    const rows = records.filter(x =>
      SCOPE[scopeKey].match(normalizeKind(x[FIELD.kind])) &&
      (teacherName ? safe(x[FIELD.teacher]) === teacherName : true)
    );

    // 1) Çekim
    const cekimHTML = renderCekimList(rows);
    // 2) Akad
    const akdHTML   = renderAkdList(rows);
    // 3) Yükleme
    const yazHTML   = renderYazList(rows);

    return `
      <td class="px-3 py-2 center-cell">${cekimHTML}</td>
      <td class="px-3 py-2 center-cell">${akdHTML}</td>
      <td class="px-3 py-2 center-cell">${yazHTML}</td>`;
  }

  // SCOPE tanımı (hangi anlatım türü hangi blokta yer alacak?)
  const SCOPE = {
    TAB:   { title:'Tabletli Konu Anlatım', match:(k)=>k===FIELD.kindTablet  },
    OZET:  { title:'Özet Anlatım',         match:(k)=>k===FIELD.kindOzet    },
    PRATIK:{ title:'Soru Pratiği',         match:(k)=>k===FIELD.kindPratik  },
    GCCK:  { title:'GCÇK',                 match:(k)=>k===FIELD.kindGcck    },
  };
  const SCOPE_ORDER = ['TAB','OZET','PRATIK','GCCK'];

  /*********************************************************************
   * 4) TABLO OLUŞTURMA
   *********************************************************************/
  function buildThead(allRows) {
    const thead = document.getElementById('thead');
    thead.innerHTML = '';

    // 1. Satır: ana sütun başlıkları
    const tr1 = document.createElement('tr');
    tr1.innerHTML = `
      <th class="px-3 py-2 unit-col">ÜNİTE</th>
      <th class="px-3 py-2 section-col">BÖLÜM</th>
      ${SCOPE_ORDER.map(scKey=>{
        const scope = SCOPE[scKey];
        // PRATIK / GCCK — öğretmen kırılımını başlıkta göstermeyelim (tek blok).
        if(scKey==='PRATIK' || scKey==='GCCK'){
          return `<th class="px-3 py-2 center-cell" colspan="3">${scope.title}</th>`;
        }
        // TAB ve ÖZET için öğretmenleri bul:
        const teachers = getTeachers(allRows, scKey);
        const totalCols = Math.max(teachers.length, 1) * 3;
        return `<th class="px-3 py-2 center-cell" colspan="${totalCols}">${scope.title}</th>`;
      }).join('')}
    `;
    thead.appendChild(tr1);

    // 2. Satır: Öğretmen başlıkları (yalnız TAB ve ÖZET)
    const tr2 = document.createElement('tr');
    tr2.innerHTML = `
      <th class="px-3 py-2"></th>
      <th class="px-3 py-2"></th>
      ${SCOPE_ORDER.map(scKey=>{
        if(scKey==='PRATIK' || scKey==='GCCK'){
          return `<th class="px-3 py-2 center-cell">Durum Başlıkları</th>
                  <th class="px-3 py-2 center-cell">Durum Başlıkları</th>
                  <th class="px-3 py-2 center-cell">Durum Başlıkları</th>`;
        }
        const teachers = getTeachers(allRows, scKey);
        return teachers.map((t,idx)=>{
          const pretty = t ? ` <span class="teacher-name">${t}</span>` : '';
          return `<th class="px-3 py-2 teacher-cap center-cell" colspan="3">${idx+1}. Anlatıcı${pretty}</th>`;
        }).join('');
      }).join('')}
    `;
    thead.appendChild(tr2);

    // 3. Satır: Çekim / Akad. / Yükleme
    const tr3 = document.createElement('tr');
    tr3.innerHTML = `
      <th class="px-3 py-2 center-cell">Ünite</th>
      <th class="px-3 py-2 center-cell">Bölüm</th>
      ${SCOPE_ORDER.map(scKey=>{
        if(scKey==='PRATIK' || scKey==='GCCK'){
          return `<th class="px-3 py-2 center-cell">Çekim</th>
                  <th class="px-3 py-2 center-cell">Akad.</th>
                  <th class="px-3 py-2 center-cell">Yükleme</th>`;
        }
        const teachers = getTeachers(allRows, scKey);
        return teachers.map(()=>`
          <th class="px-3 py-2 center-cell">Çekim</th>
          <th class="px-3 py-2 center-cell">Akad.</th>
          <th class="px-3 py-2 center-cell">Yükleme</th>
        `).join('');
      }).join('')}
    `;
    thead.appendChild(tr3);
  }

  function buildTbody(grouped){
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';
    for(const unit of Object.keys(grouped)){
      const sections = grouped[unit];
      for(const section of Object.keys(sections)){
        const rows = sections[section];

        // Satır
        const tr = document.createElement('tr');
        tr.tabIndex = 0; // klavyeyle seçilebilsin (kırmızı çerçeve için)

        // Ünite & Bölüm
        tr.innerHTML = `
          <td class="px-3 py-2">${safe(unit)}</td>
          <td class="px-3 py-2 center-cell">${safe(section)}</td>
        `;

        // SCOPE alanları
        for(const scKey of SCOPE_ORDER){
          if(scKey==='PRATIK' || scKey==='GCCK'){
            // tek blok — öğretmen kırılımı yok
            tr.innerHTML += cellsFor(rows, scKey, null);
          } else {
            // öğretmen bazlı
            const teachers = getTeachers(rows, scKey);
            if(!teachers.length){ tr.innerHTML += cellsFor([], scKey, null); continue; }
            teachers.forEach(t=>{
              tr.innerHTML += cellsFor(rows, scKey, t);
            });
          }
        }
        tbody.appendChild(tr);
      }
    }
  }

  function groupByUnitSection(rows){
    const g = {};
    rows.forEach(r=>{
      const unit = safe(r[FIELD.unit]) || '—';
      const sec  = safe(r[FIELD.section]) || '—';
      if(!g[unit]) g[unit]={};
      if(!g[unit][sec]) g[unit][sec]=[];
      g[unit][sec].push(r);
    });
    return g;
  }

  /*********************************************************************
   * 5) VERİ GETİRME
   *********************************************************************/
  async function fetchBranch(branchName){
    const { data, error } = await sb
      .from('cekimler')
      .select('*')
      .eq(FIELD.branch, branchName);
    if(error){ console.error(error); return []; }

    // Normalize anlatımTuru
    return data.map(r=>({ ...r, _kind: normalizeKind(r[FIELD.kind]) }));
  }

  /*********************************************************************
   * 6) ARAYÜZ — Sekmeler / Yükleme
   *********************************************************************/
  const tabs = document.getElementById('branchTabs');
  BRANCHES.forEach((name, i)=>{
    const btn = document.createElement('button');
    btn.className = 'px-3 py-1.5 rounded-full text-sm border bg-white hover:bg-indigo-50 hover:border-indigo-300 text-gray-700';
    btn.textContent = name;
    btn.addEventListener('click', ()=>loadBranch(name, btn));
    tabs.appendChild(btn);
    if(i===0) setTimeout(()=>btn.click(), 50);
  });

  async function loadBranch(name, btn){
    document.querySelectorAll('#branchTabs button').forEach(b=>{
      b.classList.remove('bg-indigo-600','text-white','border-indigo-600');
      b.classList.add('bg-white','text-gray-700','border');
    });
    btn.classList.remove('bg-white','text-gray-700','border');
    btn.classList.add('bg-indigo-600','text-white','border-indigo-600');

    document.getElementById('tableTitle').textContent =
      `${name} — Ünite/Bölüm tablosu`;

    const rows = await fetchBranch(name);

    // Başlık ve gövdeyi kur
    buildThead(rows);
    const grouped = groupByUnitSection(rows);
    buildTbody(grouped);
  }
  </script>
</body>
</html>
