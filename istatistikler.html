<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>İstatistikler | All Star İş Takip Programı</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    .badge{display:inline-block;padding:.22rem .55rem;border-radius:9999px;font-weight:700;font-size:.75rem;line-height:1}
    .badge-ok{background:#bbf7d0;color:#166534}
    .badge-warn{background:#fef9c3;color:#854d0e}
    .badge-info{background:#dbeafe;color:#1d4ed8}
    .badge-danger{background:#fee2e2;color:#991b1b}
    .badge-purple{background:#ede9fe;color:#5b21b6}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .tbl th,.tbl td{border-bottom:1px solid #eef2f7}
    .sticky-head thead th{position:sticky;top:0;background:#f8fafc;z-index:1}
    .seg {display:inline-flex;gap:.25rem;padding:.25rem;background:#fff;border-radius:999px;box-shadow:0 1px 2px rgba(16,24,40,.04),0 1px 1px rgba(16,24,40,.02)}
    .seg button{padding:.5rem .9rem;border-radius:999px;font-weight:600}
    .seg .on{background:#4f46e5;color:#fff;box-shadow:0 1px 2px rgba(16,24,40,.04)}
    .seg .off{color:#334155}
    .th-group{font-weight:700;text-align:center;border-bottom:1px solid #e5e7eb}
    .th-sub{font-size:.75rem;font-weight:700;text-align:center;white-space:nowrap}
    .teacher-cap{color:#7c2d12}

    .tbl th,.tbl td{ padding-left:.5rem; padding-right:.5rem; }
    .sticky-head thead th{ padding-top:.45rem; padding-bottom:.45rem; }

    /* tablo görünümü — net ızgara + tek arka plan */
    .tbl{border-collapse:separate;border-spacing:0;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
    .tbl thead th, .tbl td{border-right:1px solid #e5e7eb}
    .tbl thead tr:last-child th, .tbl tbody td{border-bottom:1px solid #e5e7eb}
    .tbl thead th:first-child, .tbl td:first-child{border-left:1px solid #e5e7eb}
    .center-cell{text-align:center}
    .left-cell{text-align:left}
    .th-group,.th-sub{background:#f8fafc}

    /* hücrede çok satırlı liste */
    .cell-stack{ display:flex; flex-direction:column; align-items:stretch; }
    .cell-stack .list-row{ display:flex; align-items:center; justify-content:center; gap:.45rem; height:28px; line-height:28px; white-space:nowrap; }
    .cell-stack .list-row + .list-row{ border-top:1px solid #e5e7eb; }

    .list-row-title{ font-weight:600; color:#111827; }

    /* fit-to-width: kaydırma olmasın */
    .tbl{ table-layout:fixed; font-size:12px; }
    .tbl th,.tbl td{ padding:.25rem .35rem; }
    .th-group,.th-sub{ font-size:.72rem; }
    .tbl td{ word-break:break-word; white-space:normal; }
    .badge{ padding:.12rem .45rem; font-size:11px; }
    .mono{ font-size:11px; }

    /* Satır tıklama vurgusu */
    .tr-focus{ outline:2px solid #ef4444; outline-offset:-2px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- HEADER -->
  <header class="bg-white shadow-sm">
    <div class="mx-auto max-w-none w-full px-4 lg:px-8 py-3 flex items-center gap-3">
      <a href="index.html" class="flex items-center gap-2">
        <img src="logo.png" alt="ÜçDörtBeş All Star" class="h-10 w-auto"/>
        <span class="text-xl font-semibold">İstatistikler</span>
      </a>
      <a href="index.html" class="ml-auto text-indigo-600 hover:text-indigo-800"><i class="fa-solid fa-house"></i> Ana sayfa</a>
    </div>
  </header>

  <main class="mx-auto max-w-none w-full px-3 lg:px-6 py-6">
    <!-- 6 sabit branş butonu -->
    <div id="branButtons" class="seg"></div>

    <!-- Kart + Tablo -->
    <div class="mt-4 bg-white rounded-2xl shadow p-4">
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <h2 id="panelTitle" class="text-lg font-semibold">Branş seçiniz</h2>
        <div id="rowCount" class="text-sm text-gray-500"></div>
      </div>

      <div class="mt-3 overflow-visible">
        <table class="tbl sticky-head w-full text-[12px]">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    /* 1) Supabase init */
    const SUPABASE_URL = 'https://nwxgigtsadesqjgflblr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53eGdpZ3RzYWRlc3FqZ2ZsYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTc0NjIsImV4cCI6MjA3NTYzMzQ2Mn0.fXEsCigwmLvQBq8_X-s_AbjJ1maioProPjPh-nNn1f4';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* 2) Branşlar */
    const BRANSLAR = [
      "LGS TÜRKÇE",
      "LGS MATEMATİK",
      "LGS FEN BİLİMLERİ",
      "LGS İNKILAP TARİHİ",
      "LGS DİN KÜLTÜRÜ",
      "LGS İNGİLİZCE"
    ];
    const seg = document.getElementById('branButtons');
    BRANSLAR.forEach((b,i)=>{
      const btn = document.createElement('button');
      btn.textContent = b;
      btn.className = i===0 ? 'on' : 'off';
      btn.addEventListener('click', ()=>{
        [...seg.children].forEach(el=>el.className='off');
        btn.className='on';
        loadFor(b);
      });
      seg.appendChild(btn);
    });

    /* 3) Yardımcılar */
    const up = s => (s ?? '').toString().toUpperCase('tr-TR').replaceAll('Ç','C');
    const normTR = s => (s ?? '')
      .toString()
      .toUpperCase('tr-TR')
      .replaceAll('Ç','C').replaceAll('Ğ','G').replaceAll('İ','I')
      .replaceAll('Ö','O').replaceAll('Ş','S').replaceAll('Ü','U')
      .replace(/[^A-Z]/g,'');

    const safe = s => (s ?? '').toString().trim();

    const SCOPE = {
      TABLETLI: { key:'TABLET', title:'TABLETLİ KONU ANLATIM', teacherSlots:2, match: t => up(t).includes('TABLET') },
      OZET: {
        key:'OZET', title:'ÖZET ANLATIM', teacherSlots:1,
        match: t => /OZET/.test(normTR(t))                 // ÖZET, ÖZET ANLATIM(I) vb.
      },
      PRATIK: { key:'PRATIK', title:'SORU PRATİĞİ', teacherSlots:1, match: t => up(t).includes('PRAT') },
      GCCK: {
        key:'GCCK', title:'GCÇK', teacherSlots:1,
        match: t => {
          const n = normTR(t);
          return n.includes('GCCK') || n.includes('GCC') || /G+C+K/.test(n); // GCCK/GCÇK tüm varyantlar
        }
      },
    };

    function getTeachers(records, scKey){
      const names = Array.from(new Set(
        records
          .filter(r => SCOPE[scKey].match(safe(r.anlatimTuru)))
          .map(r => safe(r.anlaticiOgretmen))
          .filter(Boolean)
      ));
      return names.length ? names : ['']; // boş isim için de bir sütun aç
    }

    const YAZILIM_BADGE = v => {
      switch (v) {
        case "Yüklenmeye Hazır":  return `<span class="badge badge-ok">${v}</span>`;
        case "Kontrol Ediliyor":  return `<span class="badge badge-info">${v}</span>`;
        case "Kontrol Bekliyor":  return `<span class="badge badge-warn">${v}</span>`;
        case "Teknik Düzeltmede": return `<span class="badge badge-danger">${v}</span>`;
        case "Akademik İzlemede": return `<span class="badge badge-purple">${v}</span>`;
        case "Yüklendi":          return `<span class="badge badge-ok">${v}</span>`;
        default: return v || "—";
      }
    };

    const AKD_BADGE = v => {
      const s = (v ?? '').toString().trim().toUpperCase('tr-TR');
      if (s === 'YAPILDI')   return `<span class="badge badge-ok">Yapıldı</span>`;
      if (s === 'YAPILMADI') return `<span class="badge badge-danger">Yapılmadı</span>`;
      return v || '—';
    };

    function renderAkdList(rows){
      const html = rows.map(r => `<div class="list-row">${AKD_BADGE(r.akademikIzlemeDurumu)}</div>`).join('');
      return html ? `<div class="cell-stack">${html}</div>` : '<span class="text-gray-400">—</span>';
    }

    function renderYazList(rows){
      const html = rows.map(r => {
        const v = (r.yuklemeDurumu ?? r.yuklenmeDurumu) || '';
        return `<div class="list-row">${YAZILIM_BADGE(v)}</div>`;
      }).join('');
      return html ? `<div class="cell-stack">${html}</div>` : '<span class="text-gray-400">—</span>';
    }

    function renderCekimList(rows, scKey){
      if (!rows.length) return '<span class="text-gray-400">—</span>';
      const html = rows
        .filter(r => (r.videoKodu || '').toString().trim() !== '')
        .map(r => {
          const name = (scKey === 'PRATIK' || scKey === 'GCCK')
            ? (r.testAdi || '').toString().trim()
            : (r.ders || '').toString().trim();
          const left = name ? `<span class="list-row-title">${name}</span>` : '';
          const code = `<span class="mono text-xs text-gray-700">${r.videoKodu}</span>`;
          return `<div class="list-row">${left}<span class="badge badge-ok">ÇEKİLDİ</span>${code}</div>`;
        }).join('') || '<span class="text-gray-400">—</span>';
      return `<div class="cell-stack">${html}</div>`;
    }

    // Her öğretmen için 3 hücre (çekim / akademik / yükleme) üret
    function cellsFor(records, scKey, teacherName){
      const rows = records.filter(x =>
        SCOPE[scKey].match(safe(x.anlatimTuru)) &&
        (teacherName ? safe(x.anlaticiOgretmen) === teacherName : true)
      );
      const cekimHTML = renderCekimList(rows, scKey);
      const akdHTML   = renderAkdList(rows);
      const yazHTML   = renderYazList(rows);
      return `
        <td class="px-3 py-2 center-cell">${cekimHTML}</td>
        <td class="px-3 py-2 center-cell">${akdHTML}</td>
        <td class="px-3 py-2 center-cell">${yazHTML}</td>
      `;
    }

    /* 4) Veri yükle + THEAD & TBODY oluştur */
    async function loadFor(brans){
      const thead = document.getElementById('thead');
      const tbody = document.getElementById('tbody');
      const title = document.getElementById('panelTitle');
      const rowCount = document.getElementById('rowCount');

      title.textContent = `${brans} — Ünite/Bölüm tablosu`;
      thead.innerHTML = '';
      tbody.innerHTML = `<tr><td class="px-3 py-6 text-gray-500">Yükleniyor…</td></tr>`;
      rowCount.textContent = '';

      const { data, error } = await db
        .from('cekimler')
        .select('id, unite, bolum, ders, testAdi, videoKodu, anlatimTuru, anlaticiOgretmen, akademikIzlemeDurumu, yuklemeDurumu, yuklenmeDurumu, brans')
        .eq('brans', brans);

      if (error){ console.error(error); tbody.innerHTML=''; return; }

      // 1) scope -> öğretmen listeleri (thead ve tbody aynı kaynak)
      const teacherByScope = {};
      for (const key of Object.keys(SCOPE)) {
        teacherByScope[key] = getTeachers(data, key);
      }

      // 2) THEAD (3 satır)
      const thTop  = document.createElement('tr');
      const thSub  = document.createElement('tr');
      const thSub2 = document.createElement('tr');

      thTop.innerHTML  += `<th class="th-group px-3 py-2 center-cell" rowspan="3">ÜNİTE</th>`;
      thTop.innerHTML  += `<th class="th-group px-3 py-2 center-cell" rowspan="3">BÖLÜM</th>`;

      for (const key of Object.keys(SCOPE)) {
        const sc       = SCOPE[key];
        const teachers = teacherByScope[key];
        const colSpan  = Math.max(teachers.length, 1) * 3;

        thTop.innerHTML += `<th class="th-group px-3 py-2 center-cell" colspan="${colSpan}">${sc.title}</th>`;

        (teachers.length ? teachers : ['']).forEach((t, idx) => {
          const pretty = t ? `<br/>${t}` : '';
          thSub.innerHTML  += `<th class="th-sub px-3 py-1 teacher-cap center-cell" colspan="3">${idx+1}. Anlatıcı${pretty}</th>`;
          thSub2.innerHTML += `
            <th class="th-sub px-3 py-1 center-cell">Çekim Durumu</th>
            <th class="th-sub px-3 py-1 center-cell">Akademik İzleme Durumu</th>
            <th class="th-sub px-3 py-1 center-cell">Yükleme Durumu</th>`;
        });
      }

      thead.appendChild(thTop);
      thead.appendChild(thSub);
      thead.appendChild(thSub2);

      // 3) TBODY — ÜNİTE || BÖLÜM gruplama
      const groupsMap = new Map();
      data.forEach(r => {
        const k = `${safe(r.unite)}||${safe(r.bolum)}`;
        if (!groupsMap.has(k)) groupsMap.set(k, []);
        groupsMap.get(k).push(r);
      });

      tbody.innerHTML = '';

      for (const [ubKey, recordsUB] of groupsMap.entries()) {
        const [uniteName, bolumName] = ubKey.split('||');
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td class="px-3 py-2 center-cell align-top">${uniteName || '—'}</td>
          <td class="px-3 py-2 center-cell align-top">${bolumName || '—'}</td>
        `;

        for (const key of Object.keys(SCOPE)) {
          const teachers = teacherByScope[key];
          (teachers.length ? teachers : ['']).forEach(t => {
            tr.innerHTML += cellsFor(recordsUB, key, t);
          });
        }

        tbody.appendChild(tr);
      }

      rowCount.textContent = `${groupsMap.size} satır`;

      // satır tıklama vurgusu
      tbody.addEventListener('click', (e)=>{
        const tr = e.target.closest('tr');
        if(!tr) return;
        [...tbody.querySelectorAll('tr.tr-focus')].forEach(x=>x.classList.remove('tr-focus'));
        tr.classList.add('tr-focus');
      });
    }

    // Başlangıç
    loadFor(BRANSLAR[0]);
  </script>
</body>
</html>
