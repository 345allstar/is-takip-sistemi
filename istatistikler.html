<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>İstatistikler | All Star İş Takip Programı</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    .badge{display:inline-block;padding:.22rem .55rem;border-radius:9999px;font-weight:700;font-size:.75rem;line-height:1}
    .badge-ok{background:#bbf7d0;color:#166534}
    .badge-warn{background:#fef9c3;color:#854d0e}
    .badge-info{background:#dbeafe;color:#1d4ed8}
    .badge-danger{background:#fee2e2;color:#991b1b}
    .badge-purple{background:#ede9fe;color:#5b21b6}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .tbl th,.tbl td{border-bottom:1px solid #eef2f7}
    .sticky-head thead th{position:sticky;top:0;background:#f8fafc;z-index:1}
    .seg {display:inline-flex;gap:.25rem;padding:.25rem;background:#fff;border-radius:999px;box-shadow:0 1px 2px rgba(16,24,40,.04),0 1px 1px rgba(16,24,40,.02)}
    .seg button{padding:.5rem .9rem;border-radius:999px;font-weight:600}
    .seg .on{background:#4f46e5;color:#fff;box-shadow:0 1px 2px rgba(16,24,40,.04)}
    .seg .off{color:#334155}
    .th-group{font-weight:700;text-align:center;border-bottom:1px solid #e5e7eb}
    .th-sub{font-size:.75rem;font-weight:700;text-align:center;white-space:nowrap}
    .teacher-cap{color:#7c2d12}
    /* daha kompakt görünüm için hücre iç boşluklarını azalt */
.tbl th, .tbl td { padding-left: .5rem; padding-right: .5rem; }
/* başlık satırının yüksekliğini de kısaltalım */
.sticky-head thead th { padding-top: .4rem; padding-bottom: .4rem; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- HEADER -->
  <header class="bg-white shadow-sm">
  <div class="mx-auto max-w-none w-full px-4 lg:px-8 py-3 flex items-center gap-3">
      <a href="index.html" class="flex items-center gap-2">
        <img src="logo.png" alt="ÜçDörtBeş All Star" class="h-10 w-auto"/>
        <span class="text-xl font-semibold">İstatistikler</span>
      </a>
      <a href="index.html" class="ml-auto text-indigo-600 hover:text-indigo-800"><i class="fa-solid fa-house"></i> Ana sayfa</a>
    </div>
  </header>

  <main class="mx-auto max-w-none w-full px-3 lg:px-6 py-6">
    <!-- 6 sabit branş butonu -->
    <div id="branButtons" class="seg"></div>

    <!-- Kart + Tablo -->
    <div class="mt-4 bg-white rounded-2xl shadow p-4">
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <h2 id="panelTitle" class="text-lg font-semibold">Branş seçiniz</h2>
        <div id="rowCount" class="text-sm text-gray-500"></div>
      </div>

      <div class="mt-3 overflow-visible">
  <table class="tbl sticky-head w-full text-[13px]">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    /* 1) Supabase init — BURAYI DOLDUR */
    const SUPABASE_URL = 'https://nwxgigtsadesqjgflblr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53eGdpZ3RzYWRlc3FqZ2ZsYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTc0NjIsImV4cCI6MjA3NTYzMzQ2Mn0.fXEsCigwmLvQBq8_X-s_AbjJ1maioProPjPh-nNn1f4';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* 2) Branşlar */
    const BRANSLAR = [
      "LGS TÜRKÇE",
      "LGS MATEMATİK",
      "LGS FEN BİLİMLERİ",
      "LGS İNKILAP TARİHİ",
      "LGS DİN KÜLTÜRÜ",
      "LGS İNGİLİZCE"
    ];
    const seg = document.getElementById('branButtons');
    BRANSLAR.forEach((b,i)=>{
      const btn = document.createElement('button');
      btn.textContent = b;
      btn.className = i===0 ? 'on' : 'off';
      btn.addEventListener('click', ()=>{
        [...seg.children].forEach(el=>el.className='off');
        btn.className='on';
        loadFor(b);
      });
      seg.appendChild(btn);
    });

    /* 3) Yardımcılar */
    const SCOPE = {
      TABLETLI: { key: 'TABLET',  title: 'TABLETLİ KONU ANLATIM', teacherSlots: 2, match: t => t?.toUpperCase().includes('TABLET') },
      OZET:     { key: 'OZET',    title: 'ÖZET ANLATIM',         teacherSlots: 1, match: t => t?.toUpperCase().includes('ÖZET')   },
      PRATIK:   { key: 'PRATIK',  title: 'SORU PRATİĞİ',         teacherSlots: 1, match: t => t?.toUpperCase().includes('PRAT')   },
      GCCK:     { key: 'GCCK',    title: 'GCÇK',                 teacherSlots: 1, match: t => t?.toUpperCase().includes('GCÇK')  },
    };

    const safe = s => (s ?? '').toString().trim();
    const YAZILIM_BADGE = v => {
      switch (v) {
        case "Yüklenmeye Hazır":  return `<span class="badge badge-ok">${v}</span>`;
        case "Kontrol Ediliyor":  return `<span class="badge badge-info">${v}</span>`;
        case "Kontrol Bekliyor":  return `<span class="badge badge-warn">${v}</span>`;
        case "Teknik Düzeltmede": return `<span class="badge badge-danger">${v}</span>`;
        case "Akademik İzlemede": return `<span class="badge badge-purple">${v}</span>`;
        case "Yüklendi":          return `<span class="badge badge-ok">${v}</span>`;
        default: return v || "—";
      }
    };
    const CEKIM_BADGE = count => count>0 ? `<span class="badge badge-ok">ÇEKİLDİ (${count} ders)</span>` : `<span class="badge badge-warn">Çekim yok</span>`;

    /* 4) Veri yükle + başlıkları (öğretmen adlarıyla) oluştur + tabloyu yaz */
    async function loadFor(brans){
      document.getElementById('panelTitle').textContent = `${brans} — Ünite/Bölüm tablosu`;
      const thead = document.getElementById('thead');
      const tbody = document.getElementById('tbody');
      thead.innerHTML = ''; tbody.innerHTML = '<tr><td class="px-3 py-6 text-gray-500">Yükleniyor…</td></tr>';

      // Gerekli alanlar
      const { data, error } = await db
        .from('cekimler')
        .select('id, unite, bolum, ders, testAdi, videoKodu, anlatimTuru, anlaticiOgretmen, akademikIzlemeYapilabilirligi, yuklemeDurumu, yuklenmeDurumu, brans')
        .eq('brans', brans);

      if (error){ console.error(error); tbody.innerHTML=''; return; }

      // 4.1 Her anlatım türü için öğretmen listesi (branş genelinde) → başlıklara yazacağız
      const teacherByScope = {};
      for (const key of Object.keys(SCOPE)){
        const sc = SCOPE[key];
        const uniq = [...new Set(
          data
            .filter(r => sc.match(safe(r.anlatimTuru)))
            .map(r => safe(r.anlaticiOgretmen))
            .filter(Boolean)
        )].slice(0, sc.teacherSlots);
        teacherByScope[key] = uniq;
      }

      // 4.2 Çok seviyeli THEAD kur
      const thTop = document.createElement('tr');   // grup başlıkları
      const thSub = document.createElement('tr');   // öğretmen isimleri
      const thSub2= document.createElement('tr');   // alt sütunlar

      // ÜNİTE/BÖLÜM sabit
      thTop.innerHTML  += `<th class="th-group px-3 py-2" rowspan="3">ÜNİTE</th>`;
      thTop.innerHTML  += `<th class="th-group px-3 py-2" rowspan="3">BÖLÜM</th>`;
      thSub.innerHTML  += ``;  // boş
      thSub2.innerHTML += ``;

      // Her scope için grup başlık + öğretmen + 3 alt başlık
      for (const key of Object.keys(SCOPE)){
        const sc = SCOPE[key];
        const teacherCount = Math.max(teacherByScope[key].length, 1); // hiç yoksa 1 boş blok
        thTop.innerHTML += `<th class="th-group px-3 py-2" colspan="${teacherCount*3}">${sc.title}</th>`;

        teacherByScope[key] = teacherByScope[key].length ? teacherByScope[key] : ['—'];
        teacherByScope[key].forEach((t, idx)=>{
          thSub.innerHTML += `<th class="th-sub px-3 py-1 teacher-cap" colspan="3">${idx+1}. Anlatıcı<br/>${t}</th>`;
          thSub2.innerHTML+= `
            <th class="th-sub px-3 py-1">Çekim Durumu</th>
            <th class="th-sub px-3 py-1">Akademik İzleme Durumu</th>
            <th class="th-sub px-3 py-1">Yükleme Durumu</th>`;
        });
      }

      thead.appendChild(thTop);
      thead.appendChild(thSub);
      thead.appendChild(thSub2);

      // 4.3 ÜNİTE→BÖLÜM gruplaması
      const byU = new Map();
      data.forEach(r=>{
        const u = safe(r.unite), b = safe(r.bolum);
        if (!byU.has(u)) byU.set(u,new Map());
        const byB = byU.get(u);
        if (!byB.has(b)) byB.set(b, []);
        byB.get(b).push(r);
      });

      // 4.4 Hücre üretici (tek öğretmen için 3 alt hücre)
      function cellsFor(records, scKey, teacherName){
        const rows = records.filter(x => SCOPE[scKey].match(safe(x.anlatimTuru)) && safe(x.anlaticiOgretmen) === teacherName);
        const cekimCount = rows.filter(x => safe(x.videoKodu)).length;
        const akd = rows.map(x=>safe(x.akademikIzlemeYapilabilirligi)).filter(Boolean).pop() || '—';
        const yaz = rows.map(x=>safe(x.yuklemeDurumu) || safe(x.yuklenmeDurumu)).filter(Boolean).pop() || '—';
        return `
          <td class="px-3 py-2">${CEKIM_BADGE(cekimCount)}</td>
          <td class="px-3 py-2">${akd}</td>
          <td class="px-3 py-2">${YAZILIM_BADGE(yaz)}</td>
        `;
      }

      // 4.5 Satırları yaz
      tbody.innerHTML = '';
      let satir = 0;
      [...byU.entries()].forEach(([u, byB])=>{
        const bolumEntries = [...byB.entries()];
        bolumEntries.forEach(([b, recs], i)=>{
          const tr = document.createElement('tr');

          if (i===0){
            const tdU = document.createElement('td');
            tdU.className = 'px-3 py-2 align-top font-medium';
            tdU.rowSpan = bolumEntries.length;
            tdU.textContent = u || '—';
            tr.appendChild(tdU);
          }

          tr.innerHTML += `<td class="px-3 py-2 align-top">${b || '—'}</td>`;

          // her grup için öğretmen listesine göre hücreler
          for (const key of Object.keys(SCOPE)){
            const teachers = teacherByScope[key];
            teachers.forEach(t=>{
              tr.innerHTML += cellsFor(recs, key, t==='—' ? '' : t);
            });
          }

          tbody.appendChild(tr);
          satir++;
        });
      });

      document.getElementById('rowCount').textContent = `${satir} satır`;
    }

    // Başlangıç
    loadFor(BRANSLAR[0]);
  </script>
</body>
</html>
