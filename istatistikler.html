<!DOCTYPE html>

<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>İstatistikler | All Star İş Takip Programı</title>
<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<style>
    .badge{display:inline-block;padding:.22rem .55rem;border-radius:9999px;font-weight:700;font-size:.75rem;line-height:1}
    .badge-ok{background:#bbf7d0;color:#166534}
    .badge-warn{background:#bbf7d0;color:#166534}
    .badge-info{background:#dbeafe;color:#1d4ed8}
    .badge-danger{background:#fee2e2;color:#991b1b}
    .badge-purple{background:#ede9fe;color:#5b21b6}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .tbl th,.tbl td{ border-right:1px solid #e5e7eb; border-bottom:1px solid #e5e7eb; word-break: break-word; white-space: normal; padding:.25rem .35rem; vertical-align: top;}
    .sticky-head thead th{position:sticky;top:0;background:#f8fafc;z-index:1}
    .seg {display:inline-flex;gap:.25rem;padding:.25rem;background:#fff;border-radius:999px;box-shadow:0 1px 2px rgba(16,24,40,.04),0 1px 1px rgba(16,24,40,.02)}
    .seg button{padding:.5rem .9rem;border-radius:999px;font-weight:600}
    .seg .on{background:#4f46e5;color:#fff;box-shadow:0 1px 2px rgba(16,24,40,.04)}
    .seg .off{color:#334155}
    .th-group{font-weight:700;text-align:center;border-bottom:1px solid #e5e7eb}
    .th-sub{font-size:.75rem;font-weight:700;text-align:center;white-space:nowrap}
    .teacher-cap{color:#7c2d12}
   .tbl th, .tbl td { padding-left: .5rem; padding-right: .5rem; }  /* bırak */
.sticky-head thead th { padding-top: .45rem; padding-bottom: .45rem; }  /* biraz kısalttık */
    
    /* tablo görünümü — net ızgara + zebra */
.tbl{border-collapse:separate;border-spacing:0;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden; table-layout: fixed; width:100%;}
.tbl thead th, .tbl td{ border-right:1px solid #e5e7eb; border-bottom:1px solid #e5e7eb; word-break: break-word; white-space: normal; padding:.25rem .35rem; vertical-align: top;}
.tbl thead tr:last-child th, .tbl tbody td{border-bottom:1px solid #e5e7eb}
.tbl thead th:first-child, .tbl td:first-child{border-left:1px solid #e5e7eb}
.center-cell{text-align:center}
.left-cell{text-align:left}
.th-group,.th-sub{background:#f8fafc}
.list-chip{display:inline-flex;align-items:center;justify-content:center;gap:.35rem;margin:.15rem .35rem .15rem 0;padding:.15rem .4rem;border-radius:9999px;background:#f4f4f5}
    /* daha okunaklı liste satırı */
.list-row-title { font-weight:600; color:#111827; }

/* tablo ızgarası ve zebra zaten vardı; chip'leri sadeleştirelim */
.list-chip { background:transparent; padding:0; margin:0; }

/* başlıkları çok hafif küçült + sıkılaştır */
.th-group,.th-sub { font-weight:700; }
.th-sub { font-size: .72rem; }

/* Hücreleri netçe ortalamak için yardımcı sınıf */
.center-cell { text-align:center; }
    /* Tıklanmış satır vurgusu */
.tr-focus { outline: 2px solid #ef4444; outline-offset: -2px; }

/* === cell-stack satırları: otomatik yükseklik + normal kırılma === */
.cell-stack{display:flex;flex-direction:column;align-items:stretch}

.mono{ font-size:11px; word-break:break-all; }  /* kod uzun gelirse kırabilsin */

.cell-stack .badge{line-height:1}
.cell-stack .mono,.cell-stack .list-row-title{line-height:1}

/* "1. DERS" vb. soldaki başlık çok uzarsa ellipsis uygula */
.list-row-title{
  max-width:220px;          /* istersen 200–260 arası oynat */
  white-space:normal;       /* kırılarak tam görünsün */
  overflow:visible;
  text-overflow:clip;
}
.list-row{ box-sizing: border-box; }

/* video kodları biraz ufak kalsın, tek satıra sığması kolaylaşır */
.mono{ font-size:10.5px; }
    
    /* === Sığdırma ayarları (yatay kaydırma olmasın) === */
.tbl{border-collapse:separate;border-spacing:0;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden; table-layout: fixed; width:100%;}     /* hücreleri eşit paylaştır, küçük yazı */
.tbl th,.tbl td{ border-right:1px solid #e5e7eb; border-bottom:1px solid #e5e7eb; word-break: break-word; white-space: normal; padding:.25rem .35rem; vertical-align: top;}       /* daraltılmış iç boşluk */
.th-group,.th-sub{ font-size:.72rem; }          /* başlıkları küçült */
.tbl td{ border-right:1px solid #e5e7eb; border-bottom:1px solid #e5e7eb; word-break: break-word; white-space: normal; padding:.25rem .35rem; vertical-align: top;} /* metinler sarılsın */

.badge{ padding:.12rem .45rem; font-size:11px; } /* rozetler ufak */
.mono{ font-size:11px; }                          /* video kodu ufak */
.list-row{ gap:.3rem; }                           /* satır içi boşluk küçük */

/* tek arka plan istendiği için zebra kapalı (olsa dahi) */
.tbl tbody tr:nth-child(odd){ background:transparent !important; }
  
/* === BÖLÜM'DEN SAĞA HER ŞEY ORTALI === */
.tbl tbody tr > td:not(:nth-child(-n+2)){ text-align:center; }

/* 3'lü alt sütunların ayırıcı çizgilerini belirginleştir */
/* THEAD: alt başlıkta her 3. th sonunda ayrım */
.tbl thead tr:last-child th{ border-right:1px solid #e5e7eb; }
.tbl thead tr:last-child th:nth-child(3n){
  border-right:1px solid #d1d5db;
}

/* TBODY: 1=ÜNİTE, 2=BÖLÜM; üçlüler 3–5, 6–8, 9–11...
   Bu yüzden bitiş çizgisi 5,8,11... => 3n+5 */
.tbl tbody td{ border-right:1px solid #e5e7eb; }
.tbl tbody td:nth-child(3n+5){
  border-right:1px solid #d1d5db;  /* üçlü bitişi */
}

/* Branş butonları (seg) daha estetik */
.seg{ gap:.35rem; padding:.35rem; background:#fff; border-radius:9999px;
      box-shadow:0 8px 20px rgba(17,24,39,.05), 0 2px 6px rgba(17,24,39,.04); }
.seg button{
  padding:.55rem 1rem; border-radius:9999px; font-weight:600; letter-spacing:.2px;
  transition:all .2s ease; border:1px solid transparent; background:#f3f4f6; color:#111827;
}
.seg button.off:hover{ transform:translateY(-1px); background:#e5e7eb; }
.seg .on{
  background:linear-gradient(180deg,#4f46e5,#4338ca);
  color:#fff; border-color:#4338ca; box-shadow:0 6px 14px rgba(67,56,202,.25);
}
.seg .on:hover{ filter:brightness(1.05); }
    
/* BÖLÜM'den (2. sütun) sonrası ortalı */
.tbl tbody tr > td:nth-child(n+3){ text-align:center; }
    
    /* Satırlar arası boşluk için sadece padding kullan; margin kullanma */
.cell-stack .list-row{ justify-content:center; flex-wrap:wrap; line-height:1.2; }
/* SATIR KUTUSU SABİT: aynı kutu modeli */
.list-row{
  display:flex; align-items:center; justify-content:center;
  gap:.45rem;
  margin:0;                 /* margin YOK */
  padding:.24rem 0;         /* boşluk sadece padding */
  line-height:1.2;
  box-sizing:border-box;    /* yükseklik/padding sürprizi olmasın */
}
    .cell-stack{ display:flex; flex-direction:column; align-items:stretch; }
.cell-stack .list-row + .list-row{ border-top:1px solid #e5e7eb; }
/* pad satırı: çizgiyi saklama */
.list-row.pad{ color:transparent; height:auto; line-height:1.2; }
.cell-stack .list-row + .list-row{ border-top:1px solid #e5e7eb; }
.list-row.pad{ color:transparent; height:auto; line-height:1.2; }  /* pad satırı: çizgi kalsın */
</style>
<style>
/* === Collapsible Units & Section Styling === */
.table-collapsible .unit-header {
  background: #f6f9ff;
  position: sticky;
  top: 0;
  z-index: 2;
  cursor: pointer;
}
.table-collapsible .unit-header:hover { background: #eaf1ff; }
.table-collapsible .unit-header .toggle {
  font-weight: 700;
  margin-right: .5rem;
}
.table-collapsible .section-start td {
  border-top: 2px solid #222 !important;
}
.table-collapsible .unit-start td {
  border-top: 3px solid #000 !important;
}
.table-collapsible td, .table-collapsible th {
  border: 1px solid #d0d7e2 !important;
}
.table-collapsible .unit-header td {
  border-top: 4px solid #000 !important;
  border-bottom: 2px solid #000 !important;
}
/* subtle zebra to help scan rows */
.table-collapsible tr:nth-child(even) { background: #fbfdff; }
.table-collapsible tr:nth-child(odd) { background: #fff; }
</style></head>
<body class="bg-gray-50 text-gray-800">
<!-- HEADER -->
<header class="bg-white shadow-sm">
<div class="mx-auto max-w-none w-full px-4 lg:px-8 py-3 flex items-center gap-3">
<a class="flex items-center gap-2" href="index.html">
<img alt="ÜçDörtBeş All Star" class="h-10 w-auto" src="logo.png"/>
<span class="text-xl font-semibold">İstatistikler</span>
</a>
<a class="ml-auto text-indigo-600 hover:text-indigo-800" href="index.html"><i class="fa-solid fa-house"></i> Ana sayfa</a>
</div>
</header>
<main class="mx-auto max-w-none w-full px-3 lg:px-6 py-6">
<!-- 6 sabit branş butonu -->
<div class="seg" id="branButtons"></div>
<!-- Kart + Tablo -->
<div class="mt-4 bg-white rounded-2xl shadow p-4">
<div class="flex items-center justify-between gap-4 flex-wrap">
<h2 class="text-lg font-semibold" id="panelTitle">Branş seçiniz</h2>
<div class="text-sm text-gray-500" id="rowCount"></div>
</div>
<div class="mt-3 overflow-visible">
<table class="tbl sticky-head w-full text-[12px] table-collapsible">
<thead id="thead"></thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>
</main>
<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
    /* 1) Supabase init — BURAYI DOLDUR */
    const SUPABASE_URL = 'https://nwxgigtsadesqjgflblr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53eGdpZ3RzYWRlc3FqZ2ZsYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTc0NjIsImV4cCI6MjA3NTYzMzQ2Mn0.fXEsCigwmLvQBq8_X-s_AbjJ1maioProPjPh-nNn1f4';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* 2) Branşlar */
    const BRANSLAR = [
      "LGS TÜRKÇE",
      "LGS MATEMATİK",
      "LGS FEN BİLİMLERİ",
      "LGS İNKILAP TARİHİ",
      "LGS DİN KÜLTÜRÜ",
      "LGS İNGİLİZCE"
    ];
    const seg = document.getElementById('branButtons');
    BRANSLAR.forEach((b,i)=>{
      const btn = document.createElement('button');
      btn.textContent = b;
      btn.className = i===0 ? 'on' : 'off';
      btn.addEventListener('click', ()=>{
        [...seg.children].forEach(el=>el.className='off');
        btn.className='on';
        loadFor(b);
      });
      seg.appendChild(btn);
    });

    /* 3) Yardımcılar */
    const up = s => (s ?? '').toString().toUpperCase('tr-TR').replaceAll('Ç','C');
    // TR karakterlerini düz İng'e çevir + harf dışını at (GCÇK/GCCK vb. farkları yakalamak için)
    // Öğretmen listesini getirir; hiç öğretmen adı yoksa [''] döndürür ki yine de bir sütun açılsın
function getTeachers(records, scKey){
  const names = Array.from(new Set(
    records
      .filter(r => SCOPE[scKey].match(safe(r.anlatimTuru)))
      .map(r => safe(r.anlaticiOgretmen))
      .filter(Boolean)
  ));
  return names.length ? names : [''];
}
const normTR = s => (s ?? '')
  .toString()
  .toUpperCase('tr-TR')
  .replaceAll('Ç','C').replaceAll('Ğ','G').replaceAll('İ','I')
  .replaceAll('Ö','O').replaceAll('Ş','S').replaceAll('Ü','U')
  .replace(/[^A-Z]/g,'');
    const SCOPE = {
  TABLETLI: { key:'TABLET', title:'TABLETLİ KONU ANLATIM', teacherSlots:2, match: t => up(t).includes('TABLET') },
  OZET: { 
  key:'OZET', title:'ÖZET ANLATIM', teacherSlots:1,
  match: t => /OZET/.test(normTR(t))   // ÖZET, ÖZET ANLATIM(I) vs. hepsi yakalanır
},
  PRATIK:   { key:'PRATIK', title:'SORU PRATİĞİ',          teacherSlots:1, match: t => up(t).includes('PRAT')    },
  GCCK: {
  key:'GCCK', title:'GCÇK', teacherSlots:1,
  match: t => {
    const n = normTR(t);
    // "GCÇK", "GCCK", "G C Ç K", "GÇÇK" vb. tüm varyantları yakala
    return n.includes('GCCK') || n.includes('GCC') || /G+C+K/.test(n);
  }
},
};


    const safe = s => (s ?? '').toString().trim();
    const YAZILIM_BADGE = v => {
      switch (v) {
        case "Yüklenmeye Hazır":  return `<span class="badge badge-ok">${v}</span>`;
        case "Kontrol Ediliyor":  return `<span class="badge badge-info">${v}</span>`;
        case "Kontrol Bekliyor":  return `<span class="badge badge-warn">${v}</span>`;
        case "Teknik Düzeltmede": return `<span class="badge badge-danger">${v}</span>`;
        case "Akademik İzlemede": return `<span class="badge badge-purple">${v}</span>`;
        case "Yüklendi":          return `<span class="badge badge-ok">${v}</span>`;
        default: return v || "—";
      }
    };
    // Akademik İzleme rozeti (Yapıldı / Yapılmadı / boş)
const AKD_BADGE = v => {
  const s = (v ?? '').toString().trim().toUpperCase('tr-TR');
  if (s === 'YAPILDI')   return `<span class="badge badge-ok">Yapıldı</span>`;
  if (s === 'YAPILMADI') return `<span class="badge badge-danger">Yapılmadı</span>`;
  return v || '—';
};

// Akademik liste
function renderAkdList(rows){
  const html = rows.map(r => `<div class="list-row">${AKD_BADGE(r.akademikIzlemeDurumu)}</div>`).join('');
  // Boşsa görünmez tek satır koy (— değil)
  return `<div class="cell-stack">${ html || '<div class="list-row pad">&nbsp;</div>' }</div>`;
}

// Yükleme (Yazılım) liste
function renderYazList(rows){
  const html = rows.map(r => {
    const v = (r.yuklemeDurumu ?? r.yuklenmeDurumu) || '';
    return `<div class="list-row">${YAZILIM_BADGE(v)}</div>`;
  }).join('');
  // Boşsa görünmez tek satır koy (— değil)
  return `<div class="cell-stack">${ html || '<div class="list-row pad">&nbsp;</div>' }</div>`;
}


    const CEKIM_BADGE = count => count>0 ? `<span class="badge badge-ok">ÇEKİLDİ (${count} ders)</span>` : `<span class="badge badge-warn">Çekim yok</span>`;
// Çekim listesi: "İSİM  ÇEKİLDİ  KOD"  formatı
// PRATIK ve GCCK'ta isim = testAdi, diğerlerinde ders adı.
// Hiçbir yerde "1 ders" yazmıyoruz. (Tabletli/Özet'te 1.DERS vb. zaten isimde var.)
function renderCekimList(rows, scKey){
  /* // === ESKİ FİLTRELİ KOD ===
    // HATA: Buradaki filtreleme, satır sayısını diğer
    // renderAkdList ve renderYazList ile senkron olmayan hale getiriyordu.
    if (!rows.length) {
      return `<div class="cell-stack"><div class="list-row"><span class="text-gray-400">—</span></div></div>`;
    }

    const html = rows
      .filter(r => (r.videoKodu || '').toString().trim() !== '') // <-- HATA BURADA
      .map(r => {
        // ... (eski map içeriği)
      }).join('') || `<div class="list-row"><span class="text-gray-400">—</span></div>`;

    return `<div class="cell-stack">${html}</div>`;
    // === ESKİ FİLTRELİ KOD BİTİŞİ ===
  */

  // === YENİ FİLTRESİZ KOD ===
  // Diğer renderAkdList/renderYazList ile tam senkron olması için
  // her 'row' için bir '.list-row' üretmeli.
  const html = rows.map(r => {
    const videoKodu = (r.videoKodu || '').toString().trim();

    // Video kodu yoksa, '—' içeren bir satır oluştur
    if (videoKodu === '') {
      return '<div class="list-row"><span class="text-gray-400">—</span></div>';
    }

    // Video kodu varsa, dolu satırı oluştur
    let name = (scKey === 'PRATIK' || scKey === 'GCCK')
      ? (r.testAdi || '').toString().trim()
      : (r.ders || '').toString().trim();

    // "2-A" vb. yerlerde tireden kırılmayı engelle (U+2011: non-breaking hyphen)
    name = name.replace(/(\d+)\s*-\s*([A-ZÇĞİÖŞÜ0-9]+)/g, (_, n, suf) => `${n}\u2011${suf}`);

    const left = name ? `<span class="list-row-title">${name}</span>` : '';
    const code = `<span class="mono text-xs text-gray-700">${videoKodu}</span>`;
    return `
      <div class="list-row">
        ${left}
        <span class="badge badge-ok">ÇEKİLDİ</span>
        ${code}
      </div>`;
  }).join('');

  // Diğer fonksiyonlarla (renderAkdList, renderYazList) aynı boş liste mantığını kullan
  return `<div class="cell-stack">${ html || '<div class="list-row pad">&nbsp;</div>' }</div>`;
}
    // === ESKİ FİLTRELİ KOD BİTİŞİ ===
  */

  // === YENİ FİLTRESİZ KOD ===
  // Diğer renderAkdList/renderYazList ile tam senkron olması için
  // her 'row' için bir '.list-row' üretmeli.
  const html = rows.map(r => {
    const videoKodu = (r.videoKodu || '').toString().trim();

    // Video kodu yoksa, '—' içeren bir satır oluştur
    if (videoKodu === '') {
      return '<div class="list-row"><span class="text-gray-400">—</span></div>';
    }

    // Video kodu varsa, dolu satırı oluştur
    let name = (scKey === 'PRATIK' || scKey === 'GCCK')
      ? (r.testAdi || '').toString().trim()
      : (r.ders || '').toString().trim();

    
    // "2-A" vb. yerlerde tireden kırılmayı engelle (U+2011: non-breaking hyphen)
    name = name.replace(/(\d+)\s*-\s*([A-ZÇĞİÖŞÜ0-9]+)/g, (_, n, suf) => `${n}\u2011${suf}`);

    const left = name ? `<span class="list-row-title">${name}</span>` : '';
    const code = `<span class="mono text-xs text-gray-700">${videoKodu}</span>`;
    return `
      <div class="list-row">
        ${left}
        <span class="badge badge-ok">ÇEKİLDİ</span>
        ${code}
      </div>`;
  }).join('');

  // Diğer fonksiyonlarla (renderAkdList, renderYazList) aynı boş liste mantığını kullan
  return `<div class="cell-stack">${ html || '<div class="list-row pad">&nbsp;</div>' }</div>`;
}
    
// ESKİ: her 3'lü grubu ayrı ayrı eşitliyordu
// function syncTripletHeightsForRow(tr){ ... }

// YENİ: satırdaki TÜM cell-stack'leri aynı indekslere göre eşitler
function syncRowHeights(tr){
  // ÜNİTE ve BÖLÜM’ü atla, geride kalan tüm hücrelerdeki .cell-stack’leri al
  const stacks = Array
    .from(tr.querySelectorAll('td:nth-child(n+3) .cell-stack'))
    .filter(Boolean);

  if (!stacks.length) return;

  // Her stack’teki .list-row’ları al
  const rowsPerStack = stacks.map(s => Array.from(s.querySelectorAll('.list-row')));

  // En uzun stack uzunluğunu bul
  const maxLen = Math.max(...rowsPerStack.map(r => r.length));

  // Eksik olanlara pad satır ekle ki hepsi aynı uzunlukta olsun
  for (let s = 0; s < stacks.length; s++){
    const deficit = maxLen - rowsPerStack[s].length;
    for (let k = 0; k < deficit; k++){
      const pad = document.createElement('div');
      pad.className = 'list-row pad';
      pad.innerHTML = '&nbsp;';
      stacks[s].appendChild(pad);
      rowsPerStack[s].push(pad);
    }
  }

  // Her indeks için TÜM stack’ler arasında maksimum yüksekliği bulup uygula
  for (let i = 0; i < maxLen; i++){
    let maxH = 0;

    // önce sıfırla
    for (const rows of rowsPerStack){
      const el = rows[i];
      el.style.height = '';
      el.style.minHeight = '';
      el.style.lineHeight = '1.2';
      el.style.marginTop = '0';
      el.style.marginBottom = '0';
      el.style.paddingTop = '';
      el.style.paddingBottom = '';
    }

    // ölç
    for (const rows of rowsPerStack){
      const h = Math.ceil(rows[i].getBoundingClientRect().height);
      if (h > maxH) maxH = h;
    }

    // uygula
    for (const rows of rowsPerStack){
      rows[i].style.minHeight = maxH + 'px';
      rows[i].style.height    = maxH + 'px';
    }
  }
}

// Bu fonksiyonu çağıran yerleri güncelle:
function syncAllTriplets(){
  document.querySelectorAll('#tbody tr').forEach(syncRowHeights);
}

    /* 4) Veri yükle + başlıkları (öğretmen adlarıyla) oluştur + tabloyu yaz */
    async function loadFor(brans){
      document.getElementById('panelTitle').textContent = `${brans} — Ünite/Bölüm tablosu`;
      const thead = document.getElementById('thead');
      const tbody = document.getElementById('tbody');
      thead.innerHTML = ''; tbody.innerHTML = '<tr><td class="px-3 py-6 text-gray-500">Yükleniyor…</td></tr>';

      // Gerekli alanlar
      const { data, error } = await db
        .from('cekimler')
        .select('id, unite, bolum, ders, testAdi, videoKodu, anlatimTuru, anlaticiOgretmen, akademikIzlemeDurumu, yuklemeDurumu, yuklenmeDurumu, brans')
        .eq('brans', brans);

      if (error){ console.error(error); tbody.innerHTML=''; return; }

      // 4.1 Her anlatım türü için öğretmen listesi (branş genelinde)
const teacherByScope = {};
for (const key of Object.keys(SCOPE)) {
  teacherByScope[key] = getTeachers(data, key); // isim yoksa [''] döner
}

// 4.2 Çok seviyeli THEAD kur
const thTop  = document.createElement('tr');   // grup başlıkları
const thSub  = document.createElement('tr');   // öğretmen isimleri
const thSub2 = document.createElement('tr');   // alt sütunlar

// ÜNİTE/BÖLÜM sabit
thTop.innerHTML  += `<th class="th-group px-3 py-2 center-cell" rowspan="3">ÜNİTE</th>`;
thTop.innerHTML  += `<th class="th-group px-3 py-2 center-cell" rowspan="3">BÖLÜM</th>`;
thSub.innerHTML  += ``;
thSub2.innerHTML += ``;

// Her scope için grup başlık + öğretmen + 3 alt başlık
for (const key of Object.keys(SCOPE)) {
  const sc        = SCOPE[key];
  const teachers  = teacherByScope[key];            // [''] de olabilir
  const colSpan   = Math.max(teachers.length, 1) * 3;

  thTop.innerHTML += `<th class="th-group px-3 py-2 center-cell" colspan="${colSpan}">${sc.title}</th>`;

  // Öğretmen adları
  (teachers.length ? teachers : ['']).forEach((t, idx) => {
    const prettyName = t ? `<br/>${t}` : '';        // boşsa sadece “1. Anlatıcı”
    thSub.innerHTML  += `<th class="th-sub px-3 py-1 teacher-cap center-cell" colspan="3">${idx+1}. Anlatıcı${prettyName}</th>`;
    thSub2.innerHTML += `
      <th class="th-sub px-3 py-1 center-cell">Çekim Durumu</th>
      <th class="th-sub px-3 py-1 center-cell">Akademik İzleme Durumu</th>
      <th class="th-sub px-3 py-1 center-cell">Yükleme Durumu</th>`;
  });
}

thead.appendChild(thTop);
thead.appendChild(thSub);
thead.appendChild(thSub2);


      // 4.3 ÜNİTE→BÖLÜM gruplaması
      const byU = new Map();
      data.forEach(r=>{
        const u = safe(r.unite), b = safe(r.bolum);
        if (!byU.has(u)) byU.set(u,new Map());
        const byB = byU.get(u);
        if (!byB.has(b)) byB.set(b, []);
        byB.get(b).push(r);
      });

      // 4.4 Hücre üretici (tek öğretmen için 3 alt hücre)
      function cellsFor(records, scKey, teacherName){
  const rows = records.filter(x =>
  SCOPE[scKey].match(safe(x.anlatimTuru)) &&
  (teacherName ? safe(x.anlaticiOgretmen) === teacherName : true)
);

  // 1) Çekim: kodlu liste
const cekimHTML = renderCekimList(rows, scKey);

// 2) Akademik İzleme: LISTE (yapıldı/yapılmadı)
const akdHTML = renderAkdList(rows);

// 3) Yazılım: LISTE (rozetli)
const yazHTML = renderYazList(rows);

return `
  <td class="px-3 py-2 center-cell">${cekimHTML}</td>
  <td class="px-3 py-2 center-cell">${akdHTML}</td>
  <td class="px-3 py-2 center-cell">${yazHTML}</td>
`;
}

      // 4.5 Satırları yaz
      tbody.innerHTML = '';
      let satir = 0;
      [...byU.entries()].forEach(([u, byB])=>{
        const bolumEntries = [...byB.entries()];
        bolumEntries.forEach(([b, recs], i)=>{
          const tr = document.createElement('tr');

          if (i===0){
            const tdU = document.createElement('td');
            tdU.className = 'px-3 py-2 align-top center-cell';
            tdU.rowSpan = bolumEntries.length;
            tdU.textContent = u || '—';
            tr.appendChild(tdU);
          }

          tr.innerHTML += `<td class="px-3 py-2 align-top center-cell">${b || '—'}</td>`;

          // her grup için öğretmen listesine göre hücreler
          for (const key of Object.keys(SCOPE)){
            const teachers = teacherByScope[key];
            teachers.forEach(t=>{
              tr.innerHTML += cellsFor(recs, key, t==='—' ? '' : t);
            });
          }

          tbody.appendChild(tr);
          satir++;
        });
      });

      document.getElementById('rowCount').textContent = `${satir} satır`;
    // 4.6 Üçlü kolon satırlarını hizala — ROBUST TETİK
requestAnimationFrame(() => {
  requestAnimationFrame(() => {
    syncAllTriplets();             // 1. geç
    setTimeout(syncAllTriplets, 0);  // microtask sonrası
    setTimeout(syncAllTriplets, 50); // font/render tamam garanti
  });
});

// fontlar hazır olduğunda tekrar
if (document.fonts && document.fonts.ready) {
  document.fonts.ready.then(() => {
    requestAnimationFrame(() => requestAnimationFrame(syncAllTriplets));
  });
}

      // satıra tıklayınca kırmızı çerçeve
tbody.addEventListener('click', (e)=>{
  const tr = e.target.closest('tr');
  if(!tr) return;
  [...tbody.querySelectorAll('tr.tr-focus')].forEach(x=>x.classList.remove('tr-focus'));
  tr.classList.add('tr-focus');
});
    }
// Ekran boyutu değişince tekrar hizala (GLOBAL)
window.addEventListener('resize', () => {
  document.querySelectorAll('#tbody .list-row').forEach(el => {
    el.style.height = '';
    el.style.minHeight = '';
    el.style.lineHeight = '1.2';
  });
  requestAnimationFrame(() => requestAnimationFrame(syncAllTriplets));
});
    // Başlangıç
    loadFor(BRANSLAR[0]);
  </script>
<script>
// === Collapsible Units, Section Sorting, and Border Markers ===
(function() {
  const table = document.querySelector('table.table-collapsible');
  if (!table) return;

  const rows = Array.from(table.querySelectorAll('tr'));

  // Helper: get text of cell in a given column index safely
  function cellText(tr, idx) {
    const td = tr.children[idx];
    if (!td) return '';
    return (td.innerText || td.textContent || '').trim();
  }

  // Guess the column indices for "ÜNİTE" and "BÖLÜM" by header names if possible
  const headerRow = rows.find(r => r.querySelector('th'));
  let unitCol = 0, bolumCol = 1;
  if (headerRow) {
    const headers = Array.from(headerRow.children).map(th => (th.innerText || th.textContent || '').trim().toUpperCase());
    unitCol = Math.max(0, headers.findIndex(h => h.includes('ÜNİTE')));
    bolumCol = Math.max(0, headers.findIndex(h => h.includes('BÖLÜM')));
    if (unitCol === -1) unitCol = 0;
    if (bolumCol === -1) bolumCol = 1;
  }

  // Build unit groups and section groups
  const bodyRows = rows.filter(r => !r.querySelector('th'));
  const unitGroups = [];
  let currentUnit = null;
  let currentUnitName = null;
  let lastUnitName = null;

  bodyRows.forEach((tr, i) => {
    const thisUnitName = cellText(tr, unitCol) || null;
    // We treat a row as starting a new unit if its first column has text AND it differs from the last unit name.
    const startsNewUnit = thisUnitName && thisUnitName !== lastUnitName;
    if (startsNewUnit || !currentUnit) {
      currentUnit = { name: thisUnitName || lastUnitName || ('Ünite ' + (unitGroups.length+1)), rows: [] };
      unitGroups.push(currentUnit);
      lastUnitName = thisUnitName || lastUnitName;
      // mark as unit start for thicker border
      tr.classList.add('unit-start');
    }
    currentUnit.rows.push(tr);
  });

  // Within each unit, group contiguous rows by bölüm value
  function parseBolumNumber(text) {
    // Expect formats like "1. BÖLÜM", "5. BÖLÜM", "BÖLÜM 3", etc.
    if (!text) return Number.MAX_SAFE_INTEGER;
    const m = text.match(/(\d+)/);
    return m ? parseInt(m[1], 10) : Number.MAX_SAFE_INTEGER;
  }

  unitGroups.forEach(unit => {
    const sectionGroups = [];
    let currentSec = null;
    let lastSec = null;
    unit.rows.forEach(tr => {
      const secText = cellText(tr, bolumCol);
      const secNum = parseBolumNumber(secText);
      const secKey = isFinite(secNum) ? secNum : secText;
      if (!currentSec || secKey !== lastSec) {
        currentSec = { key: secKey, num: secNum, rows: [] };
        sectionGroups.push(currentSec);
        // mark section start for clearer border
        tr.classList.add('section-start');
        lastSec = secKey;
      }
      currentSec.rows.push(tr);
    });

    // Sort section groups by num ascending; stable on non-numeric
    sectionGroups.sort((a, b) => (a.num - b.num));

    // Re-append in sorted order to enforce 1-2-3-4-5
    const parent = unit.rows[0].parentElement;
    sectionGroups.forEach(sec => sec.rows.forEach(r => parent.appendChild(r)));
    // Refresh unit.rows after DOM reordering
    unit.rows = sectionGroups.flatMap(sec => sec.rows);
  });

  // Create clickable unit headers that toggle visibility
  unitGroups.forEach(unit => {
    const firstRow = unit.rows[0];
    if (!firstRow) return;
    firstRow.classList.add('unit-header');
    // Add a toggle glyph into the first cell
    const firstCell = firstRow.children[unitCol] || firstRow.children[0];
    if (firstCell) {
      const span = document.createElement('span');
      span.className = 'toggle';
      span.textContent = '▼';
      firstCell.prepend(span);
      // Make the entire first cell act like a button
      firstCell.style.userSelect = 'none';
    }

    // Start expanded by default
    let expanded = true;
    function setExpanded(open) {
      expanded = open;
      unit.rows.forEach((row, idx) => {
        if (idx === 0) return; // keep header visible
        row.style.display = open ? '' : 'none';
      });
      const t = firstRow.querySelector('.toggle');
      if (t) t.textContent = open ? '▼' : '►';
    }
    setExpanded(true);

    firstRow.addEventListener('click', (ev) => {
      // Only toggle when clicking within the unit header row (any cell)
      setExpanded(!expanded);
    });
  });

})();
</script></body>
</html>
