<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>İstatistikler | All Star İş Takip Programı</title>

  <!-- Tailwind (projedekiyle aynı sürümü kullan) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome (ikonlar için) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    .badge{display:inline-block;padding:.25rem .6rem;border-radius:9999px;font-weight:600;font-size:.75rem;line-height:1}
    .badge-hazir{background:#bbf7d0;color:#15803d}
    .badge-kontrol-ediliyor{background:#dbeafe;color:#1d4ed8}
    .badge-kontrol-bekliyor{background:#fef9c3;color:#854d0e}
    .badge-teknik{background:#fee2e2;color:#991b1b}
    .badge-akademik{background:#ede9fe;color:#5b21b6}
    .long-code{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;word-break:break-all}
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- HEADER -->
  <header class="bg-white shadow-sm">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center gap-3">
      <a href="index.html" class="flex items-center space-x-2">
        <img src="logo.png" alt="ÜçDörtBeş All Star" class="h-12 w-auto"/>
        <span class="text-xl font-semibold">İstatistikler</span>
      </a>
      <div class="ml-auto">
        <a href="index.html" class="text-indigo-600 hover:text-indigo-800"><i class="fa-solid fa-house"></i> Ana sayfa</a>
      </div>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Ders sekmeleri -->
    <div id="dersTabs" class="flex gap-2 overflow-x-auto pb-2"></div>

    <!-- Kart -->
    <div class="mt-4 bg-white rounded-2xl shadow p-4">
      <div class="flex items-center justify-between">
        <h2 id="panelTitle" class="text-lg font-semibold">Ders seçiniz</h2>
        <div class="text-sm text-gray-500" id="rowCount"></div>
      </div>

      <!-- Tablo -->
      <div class="mt-3 overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left bg-gray-100">
            <tr>
              <th class="px-3 py-2">Çekim Tarihi</th>
              <th class="px-3 py-2">Video Kodu</th>
              <th class="px-3 py-2">Branş</th>
              <th class="px-3 py-2">Ünite</th>
              <th class="px-3 py-2">Bölüm</th>
              <th class="px-3 py-2">Ders</th>
              <th class="px-3 py-2">Test Adı</th>
              <th class="px-3 py-2">Kurgu Durumu</th>
              <th class="px-3 py-2">Yüklenme Durumu</th>
              <th class="px-3 py-2">Yönetmen</th>
            </tr>
          </thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // 1) Supabase init (diğer sayfalardakiyle birebir aynı değerleri kullan)
    const SUPABASE_URL = "/* <-- BURAYA URL */";
    const SUPABASE_ANON_KEY = "/* <-- BURAYA ANON KEY */";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 2) Yardımcılar
    const YUKLENME_BADGE = {
      'Yüklenmeye Hazır': 'badge badge-hazir',
      'Kontrol Ediliyor': 'badge badge-kontrol-ediliyor',
      'Kontrol Bekliyor': 'badge badge-kontrol-bekliyor',
      'Teknik Düzeltmede': 'badge badge-teknik',
      'Akademik İzlemede': 'badge badge-akademik'
    };
    const renderYuklenme = v => `<span class="${YUKLENME_BADGE[v]||''}">${v||''}</span>`;

    function renderVideoKoduCell(k) {
      const kisa = (k.videoKodu||'');
      const uzun = (k.videoKoduUzun||'');
      if (!kisa) return '';
      if (!uzun) return `<span class="font-mono">${kisa}</span>`;
      return `
        <div class="flex items-center gap-2">
          <span class="font-mono">${kisa}</span>
          <button class="toggle-long text-gray-500 hover:text-indigo-600" data-id="${k.id}" title="Uzun kodu göster">
            <i class="fa-regular fa-eye"></i>
          </button>
        </div>
        <div class="long-code hidden text-xs text-gray-600 mt-1" data-id="${k.id}">${uzun}</div>
      `;
    }

    // 3) Üst sekmeler: ders listesini çek
    async function loadDersTabs() {
      const { data, error } = await supabaseClient
        .from('cekimler')
        .select('ders')
        .not('ders','is',null)
        .neq('ders','')
        .order('ders', { ascending: true });

      if (error) { console.error(error); return; }

      const uniq = [...new Set(data.map(d=>d.ders))];
      const tabs = document.getElementById('dersTabs');
      tabs.innerHTML = '';
      uniq.forEach((ders, i) => {
        const btn = document.createElement('button');
        btn.className = 'px-3 py-2 rounded-full border bg-white hover:bg-indigo-50 text-sm ' + (i===0 ? 'ring-2 ring-indigo-500' : '');
        btn.textContent = ders;
        btn.dataset.ders = ders;
        btn.addEventListener('click', () => {
          tabs.querySelectorAll('button').forEach(b=>b.classList.remove('ring-2','ring-indigo-500'));
          btn.classList.add('ring-2','ring-indigo-500');
          loadTable(ders);
        });
        tabs.appendChild(btn);
      });

      if (uniq.length) loadTable(uniq[0]);
    }

    // 4) Tabloyu seçilen derse göre doldur
    async function loadTable(ders) {
      document.getElementById('panelTitle').textContent = `${ders} — liste`;
      const { data, error } = await supabaseClient
        .from('cekimler')
        .select('id, cekimTarihi, videoKodu, videoKoduUzun, brans, unite, bolum, ders, testAdi, kurguDurumu, yuklenmeDurumu, yonetmen')
        .eq('ders', ders)
        .order('cekimTarihi', { ascending: false });

      if (error) { console.error(error); return; }

      const tbody = document.getElementById('tblBody');
      tbody.innerHTML = '';
      data.forEach(k => {
        const tr = document.createElement('tr');
        tr.className = 'border-b last:border-0 hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-3 py-2 whitespace-nowrap">${k.cekimTarihi ? new Date(k.cekimTarihi).toLocaleDateString('tr-TR') : ''}</td>
          <td class="px-3 py-2">${renderVideoKoduCell(k)}</td>
          <td class="px-3 py-2">${k.brans||''}</td>
          <td class="px-3 py-2">${k.unite||''}</td>
          <td class="px-3 py-2">${k.bolum||''}</td>
          <td class="px-3 py-2">${k.ders||''}</td>
          <td class="px-3 py-2">${k.testAdi||''}</td>
          <td class="px-3 py-2">${k.kurguDurumu||''}</td>
          <td class="px-3 py-2">${renderYuklenme(k.yuklenmeDurumu)}</td>
          <td class="px-3 py-2">${k.yonetmen||''}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('rowCount').textContent = `${data.length} kayıt`;
    }

    // 5) Uzun video kodu toggle (göz ikonu)
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.toggle-long');
      if (!btn) return;
      const id = btn.dataset.id;
      const div = document.querySelector(`.long-code[data-id="${id}"]`);
      if (!div) return;
      div.classList.toggle('hidden');
      const icon = btn.querySelector('i');
      icon?.classList.toggle('fa-eye');
      icon?.classList.toggle('fa-eye-slash');
      btn.title = div.classList.contains('hidden') ? 'Uzun kodu göster' : 'Uzun kodu gizle';
    });

    // Başlat
    loadDersTabs();
  </script>
</body>
</html>
