<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>İstatistikler — Ünite/Bölüm tablosu</title>

  <!-- Tailwind (CDN) sadece stil için; localde de çalışır -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --badge-green-bg:#e8f7ed;
      --badge-green-bd:#34a853;
      --badge-amber-bg:#fff5e5;
      --badge-amber-bd:#f59e0b;
      --badge-gray-bg:#f3f4f6;
      --badge-gray-bd:#9ca3af;
    }
    body{ background:#fafafa; }
    .wrap{ max-width: 1800px; margin: 12px auto; padding: 8px 12px; }
    .cap { font-weight:600; color:#111827; }
    .subcap{ color:#6b7280; }
    .card{
      background:#fff;
      border-radius: 14px;
      box-shadow: 0 1px 0 rgba(16,24,40,.05),0 1px 2px rgba(16,24,40,.06);
      border:1px solid #f2f4f7;
      padding: 12px;
    }

    /* tablo tamamen sığsın: küçük font, sabit düzen, dar padding */
    table.ist{
      width:100%;
      border-collapse: separate;
      border-spacing:0;
      table-layout: fixed;         /* her sütun eşit ve taşma yok */
      font-size: 12px;             /* tek satıra sığması için küçük font */
    }
    .ist thead th{
      position: sticky;
      top:0;
      background:#fff;
      z-index:5;
      border-bottom:1px solid #e5e7eb;
      padding:6px 8px;
      text-align:center;
      font-weight:700;
      white-space: nowrap;
    }
    .ist tbody td{
      border-bottom:1px solid #f1f5f9;
      padding: 6px 8px;
      text-align:center;
      vertical-align: middle;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .ist tbody tr:nth-child(even){ background:#fcfcfd; }
    .ist .col-mini { width: 66px; }
    .ist .col-mid  { width: 110px; }
    .ist .col-wide { width: 160px; }

    .tag{
      display:inline-block;
      font-size:11px;
      line-height: 1;
      padding:6px 8px;
      border-radius:9999px;
      font-weight:600;
      border:1px solid var(--badge-gray-bd);
      background:var(--badge-gray-bg);
      color:#374151;
    }
    .tag.ok{
      border-color:var(--badge-green-bd);
      background:var(--badge-green-bg);
      color:#166534;
    }
    .tag.wait{
      border-color:var(--badge-amber-bd);
      background:var(--badge-amber-bg);
      color:#92400e;
    }

    .sec-title{
      display:flex; align-items:center; gap:8px;
      font-weight:700; color:#111827;
      padding:8px 6px 2px 6px;
    }
    .sec-title .dot{
      width:6px; height:6px; background:#4f46e5;border-radius:999px;
    }

    /* Başlık üst grupları (1. satır) */
    .th-group{
      text-align:center;
      font-weight:700;
      border-bottom:1px solid #e5e7eb;
      padding:6px 8px;
      background:#fff;
      position: sticky; top:0; z-index:6;
    }
    .th-sub{
      font-weight:600;
      color:#111827;
    }

    /* küçük ekranlarda içeriği biraz küçült */
    @media (max-width: 1366px){
      table.ist{ font-size: 11px; }
      .ist .col-wide{ width:140px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-2">
        <span class="text-2xl font-bold">İstatistikler</span>
        <span class="text-sm text-gray-400">/ Ünite-Bölüm tablosu</span>
      </div>
      <a href="index.html" class="text-indigo-600 hover:text-indigo-800 font-semibold">Ana sayfa</a>
    </div>

    <!-- Branş sekmeleri -->
    <div class="flex flex-wrap gap-2 mb-3">
      <button data-brans="LGS TÜRKÇE"   class="tab px-4 py-1 rounded-full text-white bg-indigo-600">LGS TÜRKÇE</button>
      <button data-brans="LGS MATEMATİK" class="tab px-4 py-1 rounded-full bg-gray-100 hover:bg-gray-200">LGS MATEMATİK</button>
      <button data-brans="LGS FEN BİLİMLERİ" class="tab px-4 py-1 rounded-full bg-gray-100 hover:bg-gray-200">LGS FEN BİLİMLERİ</button>
      <button data-brans="LGS İNKILAP TARİHİ" class="tab px-4 py-1 rounded-full bg-gray-100 hover:bg-gray-200">LGS İNKILAP TARİHİ</button>
      <button data-brans="LGS DİN KÜLTÜRÜ" class="tab px-4 py-1 rounded-full bg-gray-100 hover:bg-gray-200">LGS DİN KÜLTÜRÜ</button>
      <button data-brans="LGS İNGİLİZCE" class="tab px-4 py-1 rounded-full bg-gray-100 hover:bg-gray-200">LGS İNGİLİZCE</button>
    </div>

    <div id="panel" class="card">
      <div class="sec-title"><span class="dot"></span> <span id="title">LGS TÜRKÇE — Ünite/Bölüm tablosu</span></div>

      <div id="loading" class="p-4 text-sm text-gray-500">Yükleniyor…</div>
      <div id="host" class="overflow-hidden"></div>
    </div>
  </div>

  <!-- Supabase -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // 1) Supabase bağlantısı — (kullanıcının verdiği bilgiler)
    const SUPABASE_URL  = "https://nwxgigtsadesqjgflblr.supabase.co";
    const SUPABASE_KEY  = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53eGdpZ3RzYWRlc3FqZ2ZsYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTc0NjIsImV4cCI6MjA3NTYzMzQ2Mn0.fXEsCigwmLvQBq8_X-s_AbjJ1maioProPjPh-nNn1f4";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    /*
      2) Şema eşleme — sadece BURAYI kendi tablo alanlarına göre düzenlemen yeterli.
         - table: Supabase tablo / view adı
         - fields: veritabanındaki alan adların
         - scopes: başlıklarda göstermek istediğimiz 4 ana blok ve içinde alt sütunlar
    */
    const FIELD_MAP = {
      table  : "cekimler",               // Tablo / view adı (gerekirse değiştir)
      unit   : "unite",                  // Ünitenin adı
      bolum  : "bolum",                  // Bölüm numarası
      brans  : "brans",                  // Branş adı (LGS TÜRKÇE vs.)
      dersNo : "dersNo",                 // 1. DERS, 2. DERS bilgisi
      video  : "videoKodu",              // LGS20xxxxx
      ogret  : "anlaticiOgretmen",       // Öğretmen adı
      tur    : "anlatimTuru",            // "Tabletli Konu Anlatım" / "Özet Anlatım" / "Soru Pratiği" / "GGÇK"
      cekim  : "cekimDurumu",            // ÇEKİLDİ / ÇEKİM YOK / —
      akd    : "akademikIzleme",         // Yapıldı / Yapılabilir / —
      yuk    : "yuklemeDurumu"           // Yüklendi / Bekliyor / —
    };

    // “Yüklendi” mutlaka yeşil görünsün; aşağıdaki değerleri eşleyebiliriz
    const OK_WORDS   = new Set(["Yüklendi","Yuklendi","Yuklendi.","YUKLENDI","Yuklendi ✔","Yüklendi ✔","ÇEKİLDİ","ÇEKİLDİ ✔","Yapıldı","Yapildi"]);
    const WAIT_WORDS = new Set(["Bekliyor","Kontrol Bekliyor","Kontrol Ediliyor","Beklemede","Yapılabilir","Yapilabilir","Çekim Yok","Çekim yok"]);

    // Sütun grupları: 1) Tabletli 2) Özet 3) Soru Pratiği 4) GGÇK — her biri (Çekim, Akad., Yükleme) sütunları içerir.
    // (Sen yine de istemezsen alt başlık adlarını burada değiştirebilirsin.)
    const SCOPES = [
      { key:"Tabletli Konu Anlatım", name:"Tabletli Konu Anlatım" },
      { key:"Özet Anlatım",          name:"Özet Anlatım"          },
      { key:"Soru Pratiği",          name:"Soru Pratiği"          },
      { key:"GGÇK",                  name:"GGÇK"                  }
    ];
    const SUBS = ["Çekim","Akad.","Yükleme"];  // üç alt sütun

    // 3) UI — branş seçimi
    const tabs = Array.from(document.querySelectorAll(".tab"));
    let activeBrans = "LGS TÜRKÇE";
    tabs.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        tabs.forEach(b=>b.classList.remove("text-white","bg-indigo-600"));
        btn.classList.add("text-white","bg-indigo-600");
        activeBrans = btn.dataset.brans;
        document.getElementById("title").innerText = `${activeBrans} — Ünite/Bölüm tablosu`;
        renderForActive();
      });
    });

    // 4) Veriyi çek ve filtere / pivotla
    let allRows = [];

    async function fetchAll(){
      const { data, error } = await supabase
        .from(FIELD_MAP.table)
        .select("*")
        .order(FIELD_MAP.unit, { ascending:true })
        .order(FIELD_MAP.bolum,{ ascending:true })
        .order(FIELD_MAP.dersNo, { ascending:true });

      if(error){
        console.error(error);
        document.getElementById("loading").textContent = "Veri okunamadı. Lütfen tablo adını ve alan eşlemelerini kontrol edin.";
        return;
      }
      allRows = data || [];
    }

    function safe(v){ return (v===null||v===undefined||v==="") ? "—" : v; }

    function badge(v){
      if(OK_WORDS.has(String(v).trim()))  return `<span class="tag ok">${v}</span>`;
      if(WAIT_WORDS.has(String(v).trim()))return `<span class="tag wait">${v}</span>`;
      // özel durum: "Yüklendi" kelimesini içinde barındırıyorsa yine yeşil:
      if(String(v).toLowerCase().includes("yüklendi") || String(v).toLowerCase().includes("yuklendi")){
        return `<span class="tag ok">${v}</span>`;
      }
      return `<span class="tag">${v}</span>`;
    }

    // Bir ünitenin bir bölüm satırını, 4 scope × 3 alt sütun ile döndür
    function renderRow(unitName, bolumNo, rows){
      // rows: bu ünite & bölümdeki kayıtlar
      // her scope+subs için ilk bulduğunu göster (öğretmen kırılımı istenmediği için sade)
      const cells = [];

      // ÜnİTE / BÖLÜM
      cells.push(`<td class="col-wide">${safe(unitName)}</td>`);
      cells.push(`<td class="col-mini">${safe(bolumNo)}</td>`);

      // her scope için 3 alt sütun
      for(const sc of SCOPES){
        const subset = rows.filter(r => String(r[FIELD_MAP.tur]).trim() === sc.key);
        // alt fieldlar
        const c = safe(subset[0]?.[FIELD_MAP.cekim] ?? "—");
        const a = safe(subset[0]?.[FIELD_MAP.akd]   ?? "—");
        const y = safe(subset[0]?.[FIELD_MAP.yuk]   ?? "—");
        // Yüklendi'yi yeşil; diğerleri rozet
        cells.push(`<td>${badge(c)}</td>`);
        cells.push(`<td>${badge(a)}</td>`);
        cells.push(`<td>${badge(y)}</td>`);
      }
      return `<tr>${cells.join("")}</tr>`;
    }

    function groupByUnitBolum(rows){
      const m = new Map();
      for(const r of rows){
        if(String(r[FIELD_MAP.brans]).trim()!== String(activeBrans)) continue;
        const u = r[FIELD_MAP.unit] ?? "";
        const b = r[FIELD_MAP.bolum] ?? "";
        const key = `${u}|||${b}`;
        if(!m.has(key)) m.set(key, []);
        m.get(key).push(r);
      }
      // sırala: ünite adına göre, bölüm numarasına göre
      const arr = Array.from(m.entries());
      arr.sort((a,b)=>{
        const [ua,ba] = a[0].split("|||");
        const [ub,bb] = b[0].split("|||");
        if(ua<ub) return -1; if(ua>ub) return 1;
        return Number(ba)-Number(bb);
      });
      return arr;
    }

    function renderTable(rows){
      const host = document.getElementById("host");
      if(!rows.length){
        host.innerHTML = `<div class="p-6 text-sm text-gray-500">Kayıt bulunamadı.</div>`;
        return;
      }

      const groups = groupByUnitBolum(rows);

      // başlıklar
      // 1. satır: kocabaş: "ÜNİTE" , "BÖLÜM", sonra 4 scope × 3 alt sütun -> colspan 3
      let thead1 = `
        <tr>
          <th class="th-group col-wide" rowspan="2">ÜNİTE</th>
          <th class="th-group col-mini" rowspan="2">BÖLÜM</th>
          ${SCOPES.map(sc=>`<th class="th-group" colspan="3">${sc.name}</th>`).join("")}
        </tr>
      `;
      // 2. satır: alt başlıklar (Çekim / Akad. / Yükleme)
      let thead2 = `
        <tr>
          ${SCOPES.map(()=>`
             <th class="th-sub">Çekim</th>
             <th class="th-sub">Akad.</th>
             <th class="th-sub">Yükleme</th>
          `).join("")}
        </tr>
      `;

      // body
      let tbody = "";
      for(const [key,items] of groups){
        const [u,b] = key.split("|||");
        tbody += renderRow(u,b,items);
      }

      const html = `
        <div class="overflow-x-auto">
          <table class="ist">
            <thead>${thead1}${thead2}</thead>
            <tbody>${tbody}</tbody>
          </table>
        </div>
      `;
      host.innerHTML = html;
    }

    async function renderForActive(){
      document.getElementById("loading").style.display = "block";
      await fetchAll();
      document.getElementById("loading").style.display = "none";
      renderTable(allRows);
    }

    // İlk yüklemede:
    renderForActive();
  </script>
</body>
</html>
