<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Yönetim Paneli</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{font-family:'Inter',sans-serif}
    .card{box-shadow:0 10px 30px rgba(2,6,23,.08)}
    .th{white-space:nowrap}
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <script>
const sb = supabase.createClient(
  "https://nwxgigtsadesqjgflblr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53eGdpZ3RzYWRlc3FqZ2ZsYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTc0NjIsImV4cCI6MjA3NTYzMzQ2Mn0.fXEsCigwmLvQBq8_X-s_AbjJ1maioProPjPh-nNn1f4"
);

(async function guardAdmin(){
  if(!localStorage.getItem('auth')) { location.href='login.html'; return; }
  const email = localStorage.getItem('user');
  const { data: u } = await sb.from('users').select('id').eq('email', email).maybeSingle();
  const { data: p } = await sb.from('user_permissions').select('admin').eq('user_id', u?.id).maybeSingle();
  if(!p?.admin){ location.href='no-access.html'; }
})();
</script>

  <!-- Üst bar -->
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <img src="logo.png" class="h-6" alt="logo" onerror="this.style.display='none'">
        <h1 class="text-lg font-semibold">Yönetim Paneli</h1>
      </div>
      <div class="flex items-center gap-2">
        <a href="index.html" class="rounded-lg border px-3 py-2 text-sm hover:bg-gray-50">Anasayfa'ya Dön</a>
        <button onclick="logout()" class="rounded-lg bg-rose-500 px-3 py-2 text-sm font-semibold text-white hover:bg-rose-600">Çıkış Yap</button>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-8">
    <div class="card rounded-2xl bg-white p-6">
      <h2 class="text-2xl font-semibold mb-6">Kullanıcı Yetki Yönetimi</h2>

      <!-- Uyarı -->
      <div id="env-warning" class="mb-4 hidden rounded-md border border-amber-200 bg-amber-50 p-3 text-amber-800 text-sm">
        Supabase bilgileri bulunamadı. Tablo demo verisiyle gösteriliyor. <b>appConfig</b> bölümüne SUPABASE_URL ve SUPABASE_ANON_KEY girerseniz canlı veriyi yükler.
      </div>

      <div class="overflow-x-auto">
        <table class="w-full table-auto text-sm">
          <thead>
  <tr class="text-gray-500">
    <th class="th px-4 py-3 text-left">AD SOYAD</th>
    <th class="th px-4 py-3 text-left">E-POSTA</th>
    <th class="th px-4 py-3">Koordinatör</th>
    <th class="th px-4 py-3">Yönetmen</th>
    <th class="th px-4 py-3">Kurgu</th>
    <th class="th px-4 py-3">Teknik İzleme</th>
    <th class="th px-4 py-3">Akademik İzleme</th>
    <th class="th px-4 py-3">Yazılım</th>
    <th class="th px-4 py-3">İstatistik</th>
    <th class="th px-4 py-3">Admin</th>
    <th class="th px-4 py-3 text-right">İŞLEMLER</th>
  </tr>
</thead>

          <tbody id="tbody" class="divide-y">
            <!-- Rows render via JS -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

 <template id="row-template">
  <tr>
    <td class="px-4 py-3 font-semibold text-gray-800"></td>
    <td class="px-4 py-3 text-gray-600"></td>
    <td class="px-4 py-3 text-center"><input type="checkbox" data-key="koord" class="h-4 w-4 text-indigo-600"></td>
    <td class="px-4 py-3 text-center"><input type="checkbox" data-key="yonetmen" class="h-4 w-4 text-indigo-600"></td>
    <td class="px-4 py-3 text-center"><input type="checkbox" data-key="kurgu" class="h-4 w-4 text-indigo-600"></td>
    <td class="px-4 py-3 text-center"><input type="checkbox" data-key="teknik_izleme" class="h-4 w-4 text-indigo-600"></td>
    <td class="px-4 py-3 text-center"><input type="checkbox" data-key="akademik_izleme" class="h-4 w-4 text-indigo-600"></td>
    <td class="px-4 py-3 text-center"><input type="checkbox" data-key="yazilim" class="h-4 w-4 text-indigo-600"></td>
    <td class="px-4 py-3 text-center"><input type="checkbox" data-key="istatistik" class="h-4 w-4 text-indigo-600"></td>
    <td class="px-4 py-3 text-center"><input type="checkbox" data-key="admin" class="h-4 w-4 text-indigo-600"></td>
    <td class="px-4 py-3 text-right">
      <button class="save-btn rounded-lg bg-gray-200 px-3 py-1.5 text-xs font-semibold text-gray-700 hover:bg-gray-300">Kaydet</button>
    </td>
  </tr>
</template>

  <script>
function showToast(msg, ok=true){
  const el = document.createElement('div');
  el.className = `fixed bottom-4 right-4 rounded-lg px-4 py-2 text-sm shadow ${ok?'bg-emerald-600 text-white':'bg-rose-600 text-white'}`;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 1500);
}

// Kullanıcıları ve izinleri çek
async function fetchUsers(){
  const { data, error } = await sb
    .from('users')
    .select('id, full_name, email')
    .order('full_name', { ascending: true });
  if(error){ console.error(error); showToast('Kullanıcılar yüklenemedi', false); return []; }
  return data || [];
}

async function fetchPerms(){
  const { data, error } = await sb
    .from('user_permissions')
    .select('user_id, koord, yonetmen, kurgu, teknik_izleme, akademik_izleme, yazilim, istatistik, admin');
  if(error){ console.error(error); showToast('Yetkiler yüklenemedi', false); return {}; }
  const map = {};
  (data||[]).forEach(r=>{ map[r.user_id] = r; });
  return map;
}

async function upsertPerm(userId, perms){
  const payload = { user_id:userId, ...perms };
  const { error } = await sb.from('user_permissions').upsert(payload).select();
  if(error){ console.error(error); return {ok:false, error}; }
  return {ok:true};
}

function renderRows(users, permMap){
  const tbody = document.getElementById('tbody');
  const tpl = document.getElementById('row-template');
  tbody.innerHTML = '';

  users.forEach(u=>{
    const clone = tpl.content.cloneNode(true);
    const tds = clone.querySelectorAll('td');
    tds[0].textContent = u.full_name || '—';
    tds[1].textContent = u.email || '—';

    const defaults = { koord:false, yonetmen:false, kurgu:false, teknik_izleme:false, akademik_izleme:false, yazilim:false, istatistik:false, admin:false };
    const p = { ...defaults, ...(permMap[u.id]||{}) };

    clone.querySelectorAll('input[type="checkbox"]').forEach(inp=>{
      inp.checked = !!p[inp.dataset.key];
    });

    clone.querySelector('.save-btn').addEventListener('click', async ()=>{
      const boxes = clone.querySelectorAll('input[type="checkbox"]');
      const perms = {};
      boxes.forEach(inp=> perms[inp.dataset.key] = inp.checked);
      const res = await upsertPerm(u.id, perms);
      showToast(res.ok? 'Kaydedildi' : 'Kaydedilemedi', res.ok);
    });

    tbody.appendChild(clone);
  });
}

async function bootstrap(){
  // login yoksa çıkar
  if(!localStorage.getItem('auth')){ window.location.href='login.html'; return; }

  // Admin guard (admin değilse at)
  const email = localStorage.getItem('user');
  const { data: u } = await sb.from('users').select('id').eq('email', email).maybeSingle();
  const { data: p } = await sb.from('user_permissions').select('admin').eq('user_id', u?.id).maybeSingle();
  if(!p?.admin){ window.location.href='no-access.html'; return; }

  const [users, permMap] = await Promise.all([fetchUsers(), fetchPerms()]);
  renderRows(users, permMap);
}

window.addEventListener('DOMContentLoaded', bootstrap);
</script>
</body>
</html>
