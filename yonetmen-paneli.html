<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetmen Paneli - ÜDB All Star</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; } .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; } .searchable-select-container { position: relative; } .searchable-select-dropdown { width: 100%; max-height: 200px; overflow-y: auto; z-index: 50; } #form-container.is-active { position: relative; z-index: 60; } #cekim-tablosu { width: 100%; border-collapse: collapse; table-layout: fixed; } #table-container { max-height: 800px; overflow-y: auto; } #cekim-tablosu th, #cekim-tablosu td { text-align: center; vertical-align: middle; border-left: 1px solid #e5e7eb; padding: 0.5rem; word-break: break-word; font-size: 0.75rem; line-height: 1rem; } #cekim-tablosu th { white-space: nowrap; font-weight: 600; } #cekim-tablosu th:first-child, #cekim-tablosu td:first-child { border-left: 0; } #cekim-tablosu thead tr:last-child th { border-bottom: 2px solid #d1d5db; } .pagination-button { padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; background-color: white; color: #374151; border-radius: 0.375rem; cursor: pointer; transition: all 0.2s; } .pagination-button:hover:not(:disabled) { background-color: #f3f4f6; } .pagination-button.active { background-color: #4f46e5; color: white; border-color: #4f46e5; } .pagination-button:disabled { cursor: not-allowed; opacity: 0.5; } .notification { position: fixed; top: 1.25rem; right: 1.25rem; padding: 1rem; border-radius: 0.5rem; color: white; display: flex; align-items: center; gap: 0.75rem; z-index: 100; opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); } .notification.show { opacity: 1; transform: translateX(0); } .notification.success { background-color: #22c55e; } .notification.error { background-color: #ef4444; } .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; } .form-input-base { margin-top: 0.25rem; width: 100%; padding: 0.5rem 0.75rem; background-color: #f9fafb; border: 1px solid #d1d5db; border-radius: 0.5rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); color: #111827; placeholder-color: #9ca3af; font-size: 0.875rem; } .form-input-base:focus-within, .form-input-base:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 1px #6366f1; } .form-file-input { font-size: 0.875rem; color: #4b5563; } .form-file-input::-webkit-file-upload-button { margin-right: 0.75rem; padding: 0.5rem 1rem; border-radius: 9999px; border-width: 0; font-size: 0.875rem; font-weight: 600; background-color: #eef2ff; color: #4338ca; cursor: pointer; } .form-file-input::-webkit-file-upload-button:hover { background-color: #e0e7ff; } .file-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; padding: 0.25rem 0; } .delete-file { cursor: pointer; color: #ef4444; margin-left: 8px; }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">

    <div id="notification-container"></div>

    <div class="min-h-screen flex flex-col">
        <header class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <a href="index.html" class="flex items-center space-x-2">
                        <span class="text-xl font-bold bg-indigo-600 text-white px-2 py-1 rounded-lg">ÜDB</span>
                        <span class="text-lg font-semibold text-gray-700">All Star İş Takip Programı</span>
                    </a>
                </div>
            </div>
        </header>
        
        <main class="flex-grow p-4 sm:p-6 lg:p-8">
            <div id="form-container" class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg mb-8">
                <div class="collapsible-trigger flex justify-between items-center cursor-pointer">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center"><i class="fas fa-user-edit mr-3 text-indigo-500"></i><span id="form-title">Çekim Detayları ve Atama</span></h2>
                    <i class="fas fa-chevron-down transform transition-transform text-gray-500"></i>
                </div>
                <div class="collapsible-content mt-4 pb-56">
                    <form id="cek-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6 items-start">
                        <input type="hidden" id="editing-row-id">
                        <div>
                            <label for="yonetmen" class="form-label">Yönetmen <span class="text-red-500">*</span></label>
                            <select id="yonetmen" name="yonetmen" class="searchable-select" required>
                                <option value="">Seçiniz...</option>
                            </select>
                        </div>
                        <div>
                            <label for="akademik-dinleyici" class="form-label">Akademik Dinleyici</label>
                            <select id="akademik-dinleyici" name="akademikDinleyici" class="searchable-select">
                                <option value="">Seçiniz...</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="timecode-file" class="form-label">Time Code Dosyası Ekle (Çoklu Seçim)</label>
                            <input id="timecode-file" type="file" class="form-input-base form-file-input" multiple>
                            <div id="current-files-list" class="text-xs text-gray-500 mt-2"></div>
                        </div>
                        <div class="md:col-span-2 flex justify-end pt-4 mt-4 border-t">
                            <button type="submit" id="submit-button" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300">
                                <i class="fas fa-save mr-2"></i>Güncelle
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg">
                <div class="collapsible-trigger flex justify-between items-center cursor-pointer">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center"><i class="fas fa-list-ul mr-3 text-indigo-500"></i>Atama Bekleyen Çekimler</h2>
                    <i class="fas fa-chevron-down transform transition-transform text-gray-500"></i>
                </div>
                <div class="collapsible-content mt-4">
                    <div id="table-container" class="overflow-x-auto">
                        <table id="cekim-tablosu">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th style="width: 100px;">ÇEKİM TARİHİ</th>
                                    <th style="width: 80px;">SINAV TÜRÜ</th>
                                    <th>ANLATIM TÜRÜ</th>
                                    <th>VİDEO KODU</th>
                                    <th>BRANŞ</th>
                                    <th>ÜNİTE</th>
                                    <th>BÖLÜM</th>
                                    <th>TEST ADI</th>
                                    <th style="width: 80px;">SORU SAYISI</th>
                                    <th>ANLATICI ÖĞRETMEN</th>
                                    <th>YÖNETMEN</th>
                                    <th>AKADEMİK DİNLEYİCİ</th>
                                    <th style="width: 80px;">İŞLEMLER</th>
                                </tr>
                                <tr>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"></th>
                                </tr>
                            </thead>
                            <tbody id="cekim-tablosu-body" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                        <div id="no-data" class="text-center py-8 text-gray-500 hidden">
                            <i class="fas fa-folder-open fa-3x mb-2"></i>
                            <p>Atama bekleyen çekim bulunmuyor.</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-4 p-2 border-t">
                        <span id="record-count" class="text-sm text-gray-600"></span>
                        <div id="pagination-controls" class="flex items-center space-x-1"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- SUPABASE BAĞLANTI BİLGİLERİ ---
    const SUPABASE_URL = 'https://nwxgigtsadesqjgflblr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53eGdpZ3RzYWRlc3FqZ2ZsYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTc0NjIsImV4cCI6MjA3NTYzMzQ2Mn0.fXEsCigwmLvQBq_X-s_AbjJ1maioProPjPh-nNn1f4';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- GLOBAL DEĞİŞKENLER ve SABİT VERİLER ---
    let currentPage = 1;
    const rowsPerPage = 10;
    let allCekimler = []; // Filtreleme ve düzenleme için tüm verileri bellekte tut

    const cekForm = document.getElementById('cek-form');
    const tableBody = document.getElementById('cekim-tablosu-body');
    const editingIdInput = document.getElementById('editing-row-id');
    const formContainer = document.getElementById('form-container');
    const noDataMessage = document.getElementById('no-data');
    const recordCountEl = document.getElementById('record-count');
    const paginationControlsEl = document.getElementById('pagination-controls');
    const yonetmenler = ["Sait Eralkan", "Anıl Kolay", "Batuhan Gültekin", "Nurdan Özveren", "Merve Çoklar", "Gözde Bulut", "Ali Yıldırım", "Raşit Güngör"];
    const akademikDinleyiciler = ["Ali Yıldırım", "İsmail Tolga Aktaş", "Rahim Ural", "Burak Onay", "Betül Çiçek", "Sinem Şentürk", "Ahmet Ölmez", "Barış Özcan", "Cem Oğuz Büke", "Cihat Çiçek", "Didem Özbay Sarıaydın", "Eda Güney", "Edip İçli", "Elif Bozkurt", "Emine Bolat Kırbıyık", "Esra Dindar", "Esra Şahin", "Esra Yurttaş", "Firdevs Bozkurt", "Fuat Ses", "Hülya Güçkan Taşkın", "İbrahim Atakuru", "İbrahim Halil Kesici", "Koray Dindar", "Mehmet Bademli", "Mehmet Kırbıyık", "Muharrem Akbaş", "Özcan Kulaksız", "Raziye İnal", "Sabri Bingöl", "Semih Sunucuoğlu", "Serkan Yıldız", "Serpil Tunç İçli", "Suat Emre", "Tuğba Bostancı", "Yasin Baş", "Yavuz Selim Yıldız", "Yok"];
    
    // --- YARDIMCI FONKSİYONLAR ---
    function showNotification(message, type = 'success') {
        const container = document.getElementById('notification-container'); if (!container) return;
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
        notification.innerHTML = `<i class="fas ${iconClass}"></i><span>${message}</span>`;
        container.appendChild(notification);
        setTimeout(() => notification.classList.add('show'), 10);
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => { if (notification.parentNode === container) container.removeChild(notification); }, 500);
        }, 3000);
    }

    const formatDate = (dateString) => {
        if (!dateString) return '';
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '';
        return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
    };

    function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve({ name: file.name, data: reader.result });
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(file);
        });
    }

    // --- ARAYÜZ FONKSİYONLARI ---
    document.querySelectorAll('.collapsible-trigger').forEach(trigger => {
        trigger.addEventListener('click', () => {
            const content = trigger.nextElementSibling;
            const icon = trigger.querySelector('i:last-child');
            if (icon) icon.classList.toggle('rotate-180');
            if (content) {
                if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                    content.style.maxHeight = null;
                    content.style.overflow = 'hidden';
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                    content.style.overflow = 'visible';
                }
            }
        });
    });
    
    setTimeout(() => {
        document.querySelectorAll('.collapsible-trigger').forEach(trigger => {
            const content = trigger.nextElementSibling;
            const icon = trigger.querySelector('i:last-child');
            if (content && icon) {
                content.style.maxHeight = content.scrollHeight + "px";
                content.style.overflow = 'visible';
                icon.classList.add('rotate-180');
            }
        });
    }, 200);

    function populateSelect(selectId, data) {
        const select = document.getElementById(selectId);
        if (!select) return;
        const existingOptions = select.querySelectorAll('option:not([value=""])');
        existingOptions.forEach(opt => opt.remove());
        data.sort().forEach(item => { // Listeleri alfabetik sırala
            const option = document.createElement('option');
            option.value = item;
            option.textContent = item;
            select.appendChild(option);
        });
    }
    
    function createSearchableDropdown(selectElement) {
        const container = document.createElement('div'); container.className = 'searchable-select-container relative'; selectElement.parentNode.insertBefore(container, selectElement); selectElement.style.display = 'none'; container.appendChild(selectElement); const displayButton = document.createElement('button'); displayButton.type = 'button'; displayButton.className = 'form-input-base text-left flex justify-between items-center'; const displaySpan = document.createElement('span'); displaySpan.className = 'truncate'; displayButton.appendChild(displaySpan); const icon = document.createElement('i'); icon.className = 'fas fa-chevron-down text-gray-400'; displayButton.appendChild(icon); container.appendChild(displayButton); const dropdown = document.createElement('div'); dropdown.className = 'searchable-select-dropdown absolute hidden bg-white border border-gray-300 rounded-lg mt-1 shadow-lg'; const searchInput = document.createElement('input'); searchInput.type = 'text'; searchInput.placeholder = 'Ara...'; searchInput.className = 'block w-full p-2 border-b border-gray-200 focus:outline-none'; dropdown.appendChild(searchInput); const optionsList = document.createElement('div'); optionsList.className = 'p-1 max-h-48 overflow-y-auto'; dropdown.appendChild(optionsList); container.appendChild(dropdown); dropdown.addEventListener('click', (e) => e.stopPropagation());
        const updateOptions = () => {
            optionsList.innerHTML = ''; Array.from(selectElement.options).forEach(option => { if (option.value === "" && option.textContent.includes('Seçiniz')) return; const optionDiv = document.createElement('div'); optionDiv.textContent = option.textContent; optionDiv.dataset.value = option.value; optionDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 rounded text-sm'; optionDiv.addEventListener('click', () => { selectElement.value = option.value; displaySpan.textContent = option.textContent; displaySpan.classList.remove('text-gray-400'); document.querySelectorAll('.searchable-select-dropdown').forEach(d => d.classList.add('hidden')); selectElement.dispatchEvent(new Event('change')); }); optionsList.appendChild(optionDiv); }); const selectedOption = selectElement.querySelector(`option[value="${selectElement.value}"]`) || selectElement.options[0];
            if (selectedOption) { displaySpan.textContent = selectedOption.textContent; if(selectedOption.value === "") displaySpan.classList.add('text-gray-400'); else displaySpan.classList.remove('text-gray-400'); }
        };
        searchInput.addEventListener('input', () => { const filter = searchInput.value.toLowerCase(); optionsList.querySelectorAll('div').forEach(optionDiv => { const text = optionDiv.textContent.toLowerCase(); optionDiv.style.display = text.includes(filter) ? '' : 'none'; }); });
        displayButton.addEventListener('click', (e) => { e.stopPropagation(); if (selectElement.disabled) return; const isCurrentlyHidden = dropdown.classList.contains('hidden'); document.querySelectorAll('.searchable-select-dropdown').forEach(d => d.classList.add('hidden')); if (isCurrentlyHidden) { dropdown.classList.remove('hidden'); if(formContainer) formContainer.classList.add('is-active'); searchInput.value = ''; searchInput.dispatchEvent(new Event('input')); searchInput.focus(); } }); selectElement.updateDropdown = updateOptions; updateOptions();
    }
    const updateSelectDisplay = (selectElement) => { if(selectElement && selectElement.updateDropdown) { selectElement.updateDropdown(); } }

    // --- SUPABASE & TABLO İŞLEMLERİ ---

    async function loadCekimlerFromSupabase() {
        // Sadece yönetmeni atanmamış (null olan) kayıtları çek
        const { data, error } = await supabaseClient
            .from('cekimler')
            .select('*')
            .is('yonetmen', null) 
            .order('cekimTarihi', { ascending: false });

        if (error) {
            console.error('Veri çekerken hata:', error);
            showNotification('Veriler yüklenirken bir hata oluştu.', 'error');
            allCekimler = [];
        } else {
            allCekimler = data || [];
        }
    }

    function renderFilteredData() {
        const filterValues = Array.from(document.querySelectorAll('.filter-input')).map(input => input.value.toLowerCase());
        const filteredKayitlar = allCekimler.filter(kayit => {
            return filterValues.every((filterValue, index) => {
                if (filterValue === '') return true;
                const columns = [ formatDate(kayit.cekimTarihi), kayit.sinavTuru, kayit.anlatimTuru, kayit.videoKodu, kayit.brans, kayit.unite, kayit.bolum, kayit.testAdi, kayit.soruSayisi, kayit.anlaticiOgretmen, kayit.yonetmen, kayit.akademikDinleyici ];
                return (columns[index] || '').toString().toLowerCase().includes(filterValue);
            });
        });
        
        recordCountEl.textContent = `Toplam ${filteredKayitlar.length} kayıt bulundu.`;
        noDataMessage.classList.toggle('hidden', filteredKayitlar.length > 0);
        document.getElementById('cekim-tablosu').classList.toggle('hidden', filteredKayitlar.length === 0);
        
        displayPage(filteredKayitlar);
        setupPagination(filteredKayitlar);
    }

    async function loadAndDisplayCekimler() {
        await loadCekimlerFromSupabase();
        renderFilteredData();
    }

    cekForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const id = editingIdInput.value;
        if (!id) {
            showNotification("Lütfen düzenlemek için bir çekim seçin.", "error");
            return;
        }

        const fileInput = document.getElementById('timecode-file');
        const newFiles = Array.from(fileInput.files);
        
        const mevcutKayit = allCekimler.find(k => k.id == id);
        if (!mevcutKayit) return;

        const updateData = {
            yonetmen: document.getElementById('yonetmen').value,
            akademikDinleyici: document.getElementById('akademik-dinleyici').value
        };

        if (newFiles.length > 0) {
            try {
                const uploadedFiles = await Promise.all(newFiles.map(readFileAsDataURL));
                // Mevcut dosyalarla yeni dosyaları birleştir
                updateData.timecodeFiles = [...(mevcutKayit.timecodeFiles || []), ...uploadedFiles];
            } catch (error) {
                showNotification("Dosya yüklenirken bir hata oluştu.", "error");
                return;
            }
        }

        const { error } = await supabaseClient
            .from('cekimler')
            .update(updateData)
            .eq('id', id);

        if (error) {
            showNotification('Atama güncellenirken hata: ' + error.message, 'error');
        } else {
            showNotification('Atama başarıyla güncellendi!');
            cekForm.reset();
            document.getElementById('current-files-list').innerHTML = '';
            editingIdInput.value = '';
            updateSelectDisplay(document.getElementById('yonetmen'));
            updateSelectDisplay(document.getElementById('akademik-dinleyici'));
            await loadAndDisplayCekimler(); // Listeyi yenile
        }
    });

    function displayPage(items) {
        tableBody.innerHTML = '';
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedItems = items.slice(start, end);
        paginatedItems.forEach(kayit => {
            const row = tableBody.insertRow();
            row.dataset.id = kayit.id;
            
            const fileIcon = (kayit.timecodeFiles && kayit.timecodeFiles.length > 0)
                ? `<button class="download-files-btn ml-2 text-indigo-500 hover:text-indigo-700" title="Time Code Dosyalarını İndir" data-id="${kayit.id}"><i class="fas fa-download"></i></button>`
                : '';

            const yonetmenDurum = kayit.yonetmen 
                ? `<td class="font-semibold text-green-600 align-middle">${kayit.yonetmen}${fileIcon}</td>`
                : `<td class="font-semibold text-gray-500 align-middle">Atanmadı</td>`;
            const akademikDinleyiciDurum = kayit.akademikDinleyici 
                ? `<td class="font-semibold text-green-600 align-middle">${kayit.akademikDinleyici}</td>`
                : `<td class="font-semibold text-gray-500 align-middle">Atanmadı</td>`;
            const buttonTitle = kayit.yonetmen ? "Düzenle" : "Ata";

            row.innerHTML = `
                <td class="align-middle">${formatDate(kayit.cekimTarihi) || ''}</td>
                <td class="align-middle">${kayit.sinavTuru || ''}</td>
                <td class="align-middle">${kayit.anlatimTuru || ''}</td>
                <td class="align-middle">${kayit.videoKodu || ''}</td>
                <td class="align-middle">${kayit.brans || ''}</td>
                <td class="align-middle">${kayit.unite || ''}</td>
                <td class="align-middle">${kayit.bolum || ''}</td>
                <td class="align-middle">${kayit.testAdi || ''}</td>
                <td class="align-middle">${kayit.soruSayisi || ''}</td>
                <td class="align-middle">${kayit.anlaticiOgretmen || ''}</td>
                ${yonetmenDurum}
                ${akademikDinleyiciDurum}
                <td class="align-middle">
                    <button class="edit-row text-blue-500 hover:text-blue-700 transition-colors" title="${buttonTitle}">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </td>
            `;
        });
    }

    function setupPagination(items) {
        paginationControlsEl.innerHTML = '';
        const pageCount = Math.ceil(items.length / rowsPerPage);
        if (pageCount <= 1) return;
        
        const prevButton = document.createElement('button'); prevButton.innerHTML = `<i class="fas fa-chevron-left"></i>`; prevButton.className = 'pagination-button'; prevButton.disabled = currentPage === 1; prevButton.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderFilteredData(); } }); paginationControlsEl.appendChild(prevButton);
        for (let i = 1; i <= pageCount; i++) { const btn = document.createElement('button'); btn.innerText = i; btn.className = 'pagination-button'; if (i === currentPage) { btn.classList.add('active'); } btn.addEventListener('click', () => { currentPage = i; renderFilteredData(); }); paginationControlsEl.appendChild(btn); }
        const nextButton = document.createElement('button'); nextButton.innerHTML = `<i class="fas fa-chevron-right"></i>`; nextButton.className = 'pagination-button'; nextButton.disabled = currentPage === pageCount; nextButton.addEventListener('click', () => { if (currentPage < pageCount) { currentPage++; renderFilteredData(); } }); paginationControlsEl.appendChild(nextButton);
    }
    
    tableBody.addEventListener('click', async function(e) {
        const editButton = e.target.closest('.edit-row');
        if (editButton) {
            e.preventDefault();
            const id = editButton.closest('tr').dataset.id;
            const kayit = allCekimler.find(k => k.id == id);
            if (kayit) {
                editingIdInput.value = kayit.id;
                document.getElementById('yonetmen').value = kayit.yonetmen || '';
                document.getElementById('akademik-dinleyici').value = kayit.akademikDinleyici || '';
                updateSelectDisplay(document.getElementById('yonetmen'));
                updateSelectDisplay(document.getElementById('akademik-dinleyici'));
                
                document.getElementById('timecode-file').value = '';
                const currentFilesList = document.getElementById('current-files-list');
                currentFilesList.innerHTML = '<strong>Mevcut Dosyalar:</strong>';
                if (kayit.timecodeFiles && kayit.timecodeFiles.length > 0) {
                    kayit.timecodeFiles.forEach(file => {
                        currentFilesList.innerHTML += `<div class="file-item"><span>${file.name}</span><i class="fas fa-trash-alt delete-file" data-filename="${file.name}"></i></div>`;
                    });
                } else {
                    currentFilesList.innerHTML = 'Mevcut dosya bulunmuyor.';
                }
                document.getElementById('form-container').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        if (e.target.classList.contains('delete-file')) {
            const id = editingIdInput.value;
            const fileNameToDelete = e.target.dataset.filename;
            if (!id || !fileNameToDelete) return;
            
            const kayit = allCekimler.find(k => k.id == id);
            if (kayit && kayit.timecodeFiles) {
                const updatedFiles = kayit.timecodeFiles.filter(f => f.name !== fileNameToDelete);
                
                const { error } = await supabaseClient
                    .from('cekimler')
                    .update({ timecodeFiles: updatedFiles })
                    .eq('id', id);

                if (error) {
                    showNotification('Dosya silinirken hata: ' + error.message, 'error');
                } else {
                    showNotification('Dosya başarıyla silindi.');
                    await loadAndDisplayCekimler(); // Listeyi yenile
                    // Formu tekrar doldur
                    editButton.click();
                }
            }
        }

        const downloadBtn = e.target.closest('.download-files-btn');
        if(downloadBtn) {
            e.preventDefault();
            const id = downloadBtn.dataset.id;
            const record = allCekimler.find(r => r.id === id);
            if (record && record.timecodeFiles && record.timecodeFiles.length > 0) {
                const zip = new JSZip();
                record.timecodeFiles.forEach(file => {
                    const base64Data = file.data.split(',')[1];
                    zip.file(file.name, base64Data, { base64: true });
                });
                zip.generateAsync({ type: "blob" }).then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `${record.videoKodu || 'timecodes'}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            }
        }
    });
    
    document.querySelectorAll('.filter-input').forEach(input => {
        input.addEventListener('keyup', () => {
            currentPage = 1;
            renderFilteredData();
        });
    });

    // --- SAYFA YÜKLENDİĞİNDE ÇALIŞACAK KODLAR ---
    function initializePage() {
        populateSelect('yonetmen', yonetmenler);
        populateSelect('akademik-dinleyici', akademikDinleyiciler);
        document.querySelectorAll('.searchable-select').forEach(createSearchableDropdown);
        loadAndDisplayCekimler();
    }
    
    initializePage();
});
</script>

</body>
</html>
