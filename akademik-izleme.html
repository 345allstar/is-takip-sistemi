<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akademik İzleme Paneli - ÜDB All Star</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; } .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; } .custom-select-container { position: relative; } .custom-select-dropdown { width: 100%; max-height: 200px; overflow-y: auto; z-index: 50; } #form-container.is-active { position: relative; z-index: 60; } #cekim-tablosu { width: 100%; border-collapse: collapse; table-layout: fixed; } #table-container { max-height: 800px; overflow-y: auto; } #cekim-tablosu th, #cekim-tablosu td { text-align: center; vertical-align: middle; border-left: 1px solid #e5e7eb; padding: 0.75rem 0.5rem; font-size: 0.75rem; line-height: 1rem; } #cekim-tablosu th { white-space: nowrap; font-weight: 600; } #cekim-tablosu td { word-break: break-word; } #cekim-tablosu th:first-child, #cekim-tablosu td:first-child { border-left: 0; } #cekim-tablosu thead tr:last-child th { border-bottom: 2px solid #d1d5db; } .pagination-button { padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; background-color: white; color: #374151; border-radius: 0.375rem; cursor: pointer; transition: all 0.2s; } .pagination-button:hover:not(:disabled) { background-color: #f3f4f6; } .pagination-button.active { background-color: #4f46e5; color: white; border-color: #4f46e5; } .pagination-button:disabled { cursor: not-allowed; opacity: 0.5; } .notification { position: fixed; top: 1.25rem; right: 1.25rem; padding: 1rem; border-radius: 0.5rem; color: white; display: flex; align-items: center; gap: 0.75rem; z-index: 1000; opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); } .notification.show { opacity: 1; transform: translateX(0); } .notification.success { background-color: #22c55e; } .notification.error { background-color: #ef4444; } .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; } .form-input-base { margin-top: 0.25rem; width: 100%; padding: 0.5rem 0.75rem; background-color: #f9fafb; border: 1px solid #d1d5db; border-radius: 0.5rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); color: #111827; } .form-input-base:focus-within, .form-input-base:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 1px #6366f1; } .status-badge { display: inline-block; padding: 0.25rem 0.6rem; border-radius: 9999px; font-weight: 500; } .status-yapildi { background-color: #dcfce7; color: #166534; } .status-yapilmadi { background-color: #fee2e2; color: #991b1b; }
        .multi-select-tag { display: inline-flex; align-items: center; background-color: #e0e7ff; color: #4338ca; padding: 0.2rem 0.6rem; margin: 0.2rem; border-radius: 0.375rem; font-size: 0.8rem; }
        .multi-select-tag button { margin-left: 0.4rem; color: #4f46e5; background: none; border: none; cursor: pointer; font-size: 0.9rem; }
        .multi-select-tags-container { display: flex; flex-wrap: wrap; gap: 0.25rem; padding: 0.25rem; min-height: 42px; border: 1px solid #d1d5db; border-radius: 0.5rem; background-color: #f9fafb; margin-top: 0.25rem;}
        .multi-select-tags-container:focus-within { border-color: #6366f1; box-shadow: 0 0 0 1px #6366f1;}
        #cekim-tablosu-body tr.satir-secili { outline: 2px solid #ef4444; outline-offset: -2px; }
        .group-child { display: none; }
        .group-master td { background-color: #f9fafb; }
        .group-toggle-icon { cursor: pointer; transition: transform 0.2s ease-in-out; display: inline-block; }
        .group-toggle-icon.expanded { transform: rotate(180deg); }
        .group-count-badge { background-color: #e0e7ff; color: #4338ca; padding: 2px 6px; border-radius: 8px; font-size: 0.7rem; font-weight: 500; margin-left: 8px; }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">

    <div id="notification-container"></div>

    <div class="min-h-screen flex flex-col">
        <header class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <a href="index.html" class="flex items-center space-x-2">
                        <span class="text-xl font-bold bg-indigo-600 text-white px-2 py-1 rounded-lg">ÜDB</span>
                        <span class="text-lg font-semibold text-gray-700">All Star İş Takip Programı</span>
                    </a>
                </div>
            </div>
        </header>
        
        <main class="flex-grow p-4 sm:p-6 lg:p-8">
            <div id="form-container" class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg mb-8">
                <div class="collapsible-trigger flex justify-between items-center cursor-pointer">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center"><i class="fas fa-graduation-cap mr-3 text-indigo-500"></i><span id="form-title">Akademik İzleme Detayları</span></h2>
                    <i class="fas fa-chevron-down transform transition-transform text-gray-500"></i>
                </div>
                <div class="collapsible-content mt-6">
                    <form id="cek-form" class="space-y-6">
                        <input type="hidden" id="editing-row-id">
                        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-stretch">
                            <div class="lg:col-span-3 flex flex-col">
                                <label class="form-label mb-2">Video İzleme Ekranı</label>
                                <div id="video-placeholder" class="w-full flex-grow min-h-[400px] bg-gray-900 rounded-lg flex items-center justify-center text-gray-500">
                                    <i class="fas fa-video fa-3x"></i>
                                </div>
                            </div>
                            <div class="lg:col-span-2 flex flex-col space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2">
                                        <label class="form-label" for="akademik-izleme-ogretmeni">Akademik İzleme Öğretmeni</label>
                                        <select id="akademik-izleme-ogretmeni" name="akademikIzlemeOgretmeni">
                                            <option value="">Seçiniz...</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="form-label">Akademik İzleme Tarihi</label>
                                        <input type="date" id="akademik-izleme-tarihi" name="akademikIzlemeTarihi" class="form-input-base">
                                    </div>
                                    <div>
                                        <label class="form-label" for="akademik-izleme-durumu">Akademik İzleme Durumu</label>
                                        <select id="akademik-izleme-durumu" name="akademikIzlemeDurumu">
                                            <option value="">Seçiniz...</option>
                                            <option value="Yapıldı">Yapıldı</option>
                                            <option value="Yapılmadı">Yapılmadı</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="form-label">Video Süresi</label>
                                        <input type="text" id="video-suresi" name="videoSuresi" class="form-input-base" placeholder="Örn: 00:05:21">
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div>
                                        <label class="form-label" for="kazanim-kodu">Kazanım Kodu</label>
                                        <select id="kazanim-kodu" name="kazanimKodu" multiple>
                                            <option value="">Seçiniz...</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="form-label" for="zorluk-derecesi">Zorluk Derecesi</label>
                                        <select id="zorluk-derecesi" name="zorlukDerecesi">
                                            <option value="">Seçiniz...</option>
                                            <option value="Kolay">Kolay</option>
                                            <option value="Orta">Orta</option>
                                            <option value="Zor">Zor</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="ders-icerigi" class="form-label">Ders İçeriği (Detay Göster)</label>
                                        <textarea id="ders-icerigi" name="dersIcerigi" rows="2" class="form-input-base" placeholder="Ders içeriği detaylarını buraya yazın..."></textarea>
                                    </div>
                                    <div>
                                        <label class="form-label">Cevap Anahtarları</label>
                                        <input type="text" id="cevap-anahtarlari" name="cevapAnahtarlari" class="form-input-base" placeholder="Örn: 1-A, 2-C, 3-D...">
                                    </div>
                                    <div>
                                        <label class="form-label">Anahtar Kelimeler</label>
                                        <input type="text" id="anahtar-kelimeler" name="anahtarKelimeler" class="form-input-base" placeholder="Kelimeleri virgülle ayırarak yazın...">
                                    </div>
                                </div>
                                <div>
                                    <label class="form-label">Öneri-İstek</label>
                                    <textarea id="oneri-istek" name="oneriIstek" rows="2" class="form-input-base" placeholder="Varsa öneri veya isteklerinizi yazın..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end pt-4 border-t">
                            <button type="submit" id="submit-button" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-indigo-700">
                                <i class="fas fa-save mr-2"></i>Tüm Bilgileri Güncelle
                            </button>
                        </div>
                        <div class="mt-4 pt-4 border-t">
                            <label for="akademik-izleme-notu" class="form-label">Akademik İzleme Notu (Ayrı Kaydedilir)</label>
                            <textarea id="akademik-izleme-notu" name="akademikIzlemeNotu" rows="6" class="form-input-base" placeholder="Detaylı akademik izleme notlarınızı buraya yazın..."></textarea>
                            <div class="flex justify-end mt-3">
                                <button type="button" id="kaydet-notu-btn" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-green-700">
                                    <i class="fas fa-file-alt mr-2"></i>Notu Kaydet ve İndir (.txt)
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg">
                <div class="collapsible-trigger flex justify-between items-center cursor-pointer">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center"><i class="fas fa-list-ul mr-3 text-indigo-500"></i>İzleme Bekleyen Çekimler</h2>
                    <i class="fas fa-chevron-down transform transition-transform text-gray-500"></i>
                </div>
                <div class="collapsible-content mt-4">
                    <div id="table-container" class="overflow-x-auto">
                        <table id="cekim-tablosu">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th>ÇEKİM TARİHİ</th> <th>ANLATIM TÜRÜ</th> <th style="width: 160px;">VİDEO KODU</th> <th>BRANŞ</th> <th>ÜNİTE</th> <th>BÖLÜM</th> <th>DERS</th> <th>TEST ADI</th> <th>SORU SAYISI</th> <th>AKADEMİK İZL. ÖĞRETMENİ</th> <th>AKADEMİK İZL. TARİHİ</th> <th>DURUM</th> <th>İŞLEMLER</th>
                                </tr>
                                <tr>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"><input type="text" placeholder="Filtrele..." class="filter-input w-full text-xs p-1 border rounded"></th>
                                    <th class="p-2"></th>
                                </tr>
                            </thead>
                            <tbody id="cekim-tablosu-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                        <div id="no-data" class="text-center py-8 text-gray-500 hidden">
                            <i class="fas fa-folder-open fa-3x mb-2"></i>
                            <p>Akademik izleme için uygun kayıt bulunmuyor.</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-4 p-2 border-t">
                        <span id="record-count" class="text-sm text-gray-600"></span>
                        <div id="pagination-controls" class="flex items-center space-x-1"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const SUPABASE_URL = 'https://nwxgigtsadesqjgflblr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53eGdpZ3RzYWRlc3FqZ2ZsYmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTc0NjIsImV4cCI6MjA3NTYzMzQ2Mn0.fXEsCigwmLvQBq8_X-s_AbjJ1maioProPjPh-nNn1f4';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentPage = 1;
    const rowsPerPage = 20;
    let allCekimler = [];

    const akademikIzlemeOgretmenleri = ["Ali Yıldırım", "İsmail Tolga Aktaş", "Rahim Ural", "Burak Onay", "Betül Çiçek", "Sinem Şentürk", "Ahmet Ölmez", "Barış Özcan", "Cem Oğuz Büke", "Cihat Çiçek", "Didem Özbay Sarıaydın", "Eda Güney", "Edip İçli", "Elif Bozkurt", "Emine Bolat Kırbıyık", "Esra Dindar", "Esra Şahin", "Esra Yurttaş", "Firdevs Bozkurt", "Fuat Ses", "Hülya Güçkan Taşkın", "İbrahim Atakuru", "İbrahim Halil Kesici", "Koray Dindar", "Mehmet Bademli", "Mehmet Kırbıyık", "Muharrem Akbaş", "Özcan Kulaksız", "Raziye İnal", "Sabri Bingöl", "Semih Sunucuoğlu", "Serkan Yıldız", "Serpil Tunç İçli", "Suat Emre", "Tuğba Bostancı", "Yasin Baş", "Yavuz Selim Yıldız"];
    const kazanimKodlari = ["25100 - Çarpanlar Ve Katlar", "25110 - Asal Çarpanlara Ayırma", "25120 - Aralarında Asal", "25130 - Ebob", "25140 - Ekok", "25150 - Ebob-Ekok Problemleri", "25200 - Üslü İfadeler", "86070 - Kişisel Görüşleri İfade Etme"];

    const cekForm = document.getElementById('cek-form');
    const tableBody = document.getElementById('cekim-tablosu-body');
    const editingIdInput = document.getElementById('editing-row-id');
    const noDataMessage = document.getElementById('no-data');
    const recordCountEl = document.getElementById('record-count');
    const paginationControlsEl = document.getElementById('pagination-controls');
    const kaydetNotuBtn = document.getElementById('kaydet-notu-btn');

    function showNotification(message, type = 'success') { const container = document.getElementById('notification-container'); if (!container) return; const notification = document.createElement('div'); notification.className = `notification ${type}`; notification.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-times-circle'}"></i><span>${message}</span>`; container.appendChild(notification); setTimeout(() => notification.classList.add('show'), 10); setTimeout(() => { notification.classList.remove('show'); setTimeout(() => { if (notification.parentNode === container) container.removeChild(notification); }, 500); }, 3000); }
    const formatDate = (dateString) => { if (!dateString) return ''; const date = new Date(dateString + 'T00:00:00'); return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`; };
    
    function updateCollapsibleHeight(contentElement) {
        if (contentElement && contentElement.style.maxHeight && contentElement.style.maxHeight !== '0px') {
            requestAnimationFrame(() => {
                contentElement.style.maxHeight = contentElement.scrollHeight + 'px';
            });
        }
    }

    document.querySelectorAll('.collapsible-trigger').forEach(trigger => { trigger.addEventListener('click', () => { const content = trigger.nextElementSibling; const icon = trigger.querySelector('i:last-child'); if (icon) icon.classList.toggle('rotate-180'); if (content.style.maxHeight && content.style.maxHeight !== '0px') { content.style.maxHeight = null; } else { content.style.maxHeight = content.scrollHeight + "px"; } }); });
    function createSearchableDropdown(selectElement) { const container = document.createElement('div'); container.className = 'custom-select-container relative'; selectElement.parentNode.insertBefore(container, selectElement); selectElement.style.display = 'none'; container.appendChild(selectElement); const displayButton = document.createElement('button'); displayButton.type = 'button'; displayButton.className = 'form-input-base text-left flex justify-between items-center'; const displaySpan = document.createElement('span'); displaySpan.className = 'truncate'; displayButton.appendChild(displaySpan); const icon = document.createElement('i'); icon.className = 'fas fa-chevron-down text-gray-400'; displayButton.appendChild(icon); container.appendChild(displayButton); const dropdown = document.createElement('div'); dropdown.className = 'custom-select-dropdown absolute hidden bg-white border border-gray-300 rounded-lg mt-1 shadow-lg w-full'; const searchInput = document.createElement('input'); searchInput.type = 'text'; searchInput.placeholder = 'Ara...'; searchInput.className = 'block w-full p-2 border-b border-gray-200 focus:outline-none'; dropdown.appendChild(searchInput); const optionsList = document.createElement('div'); optionsList.className = 'p-1 max-h-48 overflow-y-auto'; dropdown.appendChild(optionsList); container.appendChild(dropdown); const updateOptions = () => { optionsList.innerHTML = ''; Array.from(selectElement.options).forEach(option => { if (option.value === "" && option.textContent.includes('Seçiniz')) return; const optionDiv = document.createElement('div'); optionDiv.textContent = option.textContent; optionDiv.dataset.value = option.value; optionDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 rounded text-sm'; optionDiv.addEventListener('click', () => { selectElement.value = option.value; displaySpan.textContent = option.textContent; displaySpan.classList.remove('text-gray-400'); dropdown.classList.add('hidden'); selectElement.dispatchEvent(new Event('change')); }); optionsList.appendChild(optionDiv); }); const selectedOption = selectElement.querySelector(`option[value="${selectElement.value}"]`) || selectElement.options[0]; if (selectedOption) { displaySpan.textContent = selectedOption.textContent; if(selectedOption.value === "") displaySpan.classList.add('text-gray-400'); else displaySpan.classList.remove('text-gray-400'); } }; searchInput.addEventListener('input', () => { const filter = searchInput.value.toLowerCase(); optionsList.querySelectorAll('div').forEach(optionDiv => { const text = optionDiv.textContent.toLowerCase(); optionDiv.style.display = text.includes(filter) ? '' : 'none'; }); }); displayButton.addEventListener('click', (e) => { e.stopPropagation(); if (selectElement.disabled) return; document.querySelectorAll('.custom-select-dropdown').forEach(d => { if(d !== dropdown) d.classList.add('hidden'); }); dropdown.classList.toggle('hidden'); if(!dropdown.classList.contains('hidden')) { searchInput.value = ''; searchInput.dispatchEvent(new Event('input')); searchInput.focus(); } }); selectElement.updateDropdown = updateOptions; updateOptions(); }
    function createMultiSelectDropdown(selectElement) { const container = document.createElement('div'); container.className = 'custom-select-container relative'; selectElement.parentNode.insertBefore(container, selectElement); selectElement.style.display = 'none'; const tagsContainer = document.createElement('div'); tagsContainer.className = 'multi-select-tags-container'; container.appendChild(tagsContainer); const dropdown = document.createElement('div'); dropdown.className = 'custom-select-dropdown absolute hidden bg-white border border-gray-300 rounded-lg mt-1 shadow-lg w-full'; const searchInput = document.createElement('input'); searchInput.type = 'text'; searchInput.placeholder = 'Kazanım ara...'; searchInput.className = 'block w-full p-2 border-b border-gray-200 focus:outline-none'; dropdown.appendChild(searchInput); const optionsList = document.createElement('div'); optionsList.className = 'p-1 max-h-48 overflow-y-auto'; dropdown.appendChild(optionsList); container.appendChild(dropdown); const updateTags = () => { tagsContainer.innerHTML = ''; Array.from(selectElement.selectedOptions).forEach(option => { const tag = document.createElement('div'); tag.className = 'multi-select-tag'; tag.textContent = option.textContent; const removeBtn = document.createElement('button'); removeBtn.innerHTML = '&times;'; removeBtn.addEventListener('click', (e) => { e.stopPropagation(); option.selected = false; updateTags(); updateOptions(); }); tag.appendChild(removeBtn); tagsContainer.appendChild(tag); }); }; const updateOptions = () => { optionsList.innerHTML = ''; Array.from(selectElement.options).forEach(option => { if (!option.value) return; const optionDiv = document.createElement('div'); optionDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 rounded text-sm flex items-center justify-between'; optionDiv.textContent = option.textContent; optionDiv.dataset.value = option.value; if (option.selected) { optionDiv.classList.add('bg-indigo-50', 'font-semibold'); } optionDiv.addEventListener('click', () => { option.selected = !option.selected; updateTags(); updateOptions(); selectElement.dispatchEvent(new Event('change')); }); optionsList.appendChild(optionDiv); }); }; searchInput.addEventListener('input', () => { const filter = searchInput.value.toLowerCase(); optionsList.querySelectorAll('div').forEach(optionDiv => { optionDiv.style.display = optionDiv.textContent.toLowerCase().includes(filter) ? '' : 'flex'; }); }); tagsContainer.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.custom-select-dropdown').forEach(d => { if(d !== dropdown) d.classList.add('hidden'); }); dropdown.classList.toggle('hidden'); if (!dropdown.classList.contains('hidden')) { searchInput.value = ''; searchInput.dispatchEvent(new Event('input')); searchInput.focus(); } }); selectElement.updateDropdown = () => { updateTags(); updateOptions(); }; updateOptions(); updateTags(); }
    const updateSelectDisplay = (selectElement, values) => { if (!selectElement) return; if (selectElement.multiple) { Array.from(selectElement.options).forEach(opt => { opt.selected = (values && values.includes(opt.value)); }); } else { selectElement.value = values || ''; } if(selectElement.updateDropdown) { selectElement.updateDropdown(); } }
    function populateSelect(selectId, data) { const select = document.getElementById(selectId); if(!select) return; data.forEach(item => { const option = document.createElement('option'); option.value = item; option.textContent = item; select.appendChild(option); }); }
    
    async function loadAndDisplayCekimler() {
    const { data, error } = await supabaseClient
        .from('cekimler')
        .select('*')
        .order('cekimTarihi', { ascending: false })
        .range(0, 100000); // <-- BU SATIRI EKLEYİN
        if (error) { showNotification('Veri yüklenirken hata oluştu: ' + error.message, 'error'); allCekimler = []; } 
        else { allCekimler = data || []; }
        
        const izlenebilirCekimler = allCekimler.filter(k => k.akademikIzlemeYapilabilirligi === 'Yapılabilir');
        const filterValues = Array.from(document.querySelectorAll('.filter-input')).map(input => input.value.toLowerCase());
        const filteredKayitlar = izlenebilirCekimler.filter(kayit => {
            return filterValues.every((filterValue, index) => {
                if (filterValue === '') return true;
                const columns = [ formatDate(kayit.cekimTarihi), kayit.anlatimTuru, kayit.videoKodu, kayit.brans, kayit.unite, kayit.bolum, kayit.ders, kayit.testAdi, kayit.soruSayisi, kayit.akademikIzlemeOgretmeni, formatDate(kayit.akademikIzlemeTarihi), kayit.akademikIzlemeDurumu ];
                return (columns[index] || '').toString().toLowerCase().includes(filterValue);
            });
        });

        const groupedData = Object.values(filteredKayitlar.reduce((acc, item) => {
            const key = item.videoKodu || `no-code-${item.id}`;
            if (!acc[key]) acc[key] = [];
            acc[key].push(item);
            return acc;
        }, {}));

        recordCountEl.textContent = `Toplam ${filteredKayitlar.length} kayıt bulundu.`;
        noDataMessage.classList.toggle('hidden', filteredKayitlar.length > 0);
        document.getElementById('cekim-tablosu').classList.toggle('hidden', filteredKayitlar.length === 0);
        
        displayPage(groupedData);
        setupPagination(groupedData);

        document.querySelectorAll('.collapsible-content').forEach(content => {
            if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                updateCollapsibleHeight(content);
            }
        });
    }
    
    function displayPage(groups) {
        tableBody.innerHTML = '';
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedGroups = groups.slice(start, end);

        paginatedGroups.forEach(groupItems => {
            groupItems.forEach((kayit, index) => {
                const row = tableBody.insertRow();
                const isMaster = index === 0;
                const isGrouped = groupItems.length > 1;

                row.dataset.id = kayit.id;
                
                if (isMaster) {
                    row.classList.add('group-master');
                } else {
                    row.classList.add('group-child');
                    row.dataset.group = kayit.videoKodu || `no-code-${kayit.id}`;
                }

                let durumClass = kayit.akademikIzlemeDurumu === 'Yapıldı' ? 'status-yapildi' : 'status-yapilmadi';
                const noteIcon = (kayit.akademikIzlemeNotu && kayit.akademikIzlemeNotu.content) ? `<button class="download-note-btn ml-2 text-green-500 hover:text-green-700" title="Akademik Notu İndir" data-id="${kayit.id}"><i class="fas fa-file-alt"></i></button>` : '';
                const viewIcon = `<button class="view-akademik-btn ml-2 text-gray-500 hover:text-blue-600" title="Bu Kaydı Formda Görüntüle" data-id="${kayit.id}"><i class="fas fa-eye"></i></button>`;
                
                const videoKoduHtml = isMaster && isGrouped 
                    ? `<div class="flex items-center justify-center" style="white-space: nowrap;">
                         <i class="fas fa-chevron-down group-toggle-icon" data-group="${kayit.videoKodu}"></i>
                         <span class="ml-2">${kayit.videoKodu || ''}</span>
                         <span class="group-count-badge">${groupItems.length}</span>
                       </div>`
                    : (kayit.videoKodu || '');

                row.innerHTML = `<td>${formatDate(kayit.cekimTarihi)}</td><td>${kayit.anlatimTuru || ''}</td><td>${videoKoduHtml}</td><td>${kayit.brans || ''}</td><td>${kayit.unite || ''}</td><td>${kayit.bolum || ''}</td><td>${kayit.ders || ''}</td><td>${kayit.testAdi || ''}</td><td>${kayit.soruSayisi || ''}</td><td>${kayit.akademikIzlemeOgretmeni || ''}${noteIcon}${viewIcon}</td><td>${formatDate(kayit.akademikIzlemeTarihi)}</td><td><span class="status-badge ${durumClass}">${kayit.akademikIzlemeDurumu || 'Belirtilmedi'}</span></td><td><button class="edit-row text-blue-500 hover:text-blue-700" title="Düzenle"><i class="fas fa-pencil-alt"></i></button></td>`;
            });
        });
    }

    function setupPagination(groups) {
        paginationControlsEl.innerHTML = '';
        const pageCount = Math.ceil(groups.length / rowsPerPage);
        if (pageCount <= 1) return;
        const prevButton = document.createElement('button'); prevButton.innerHTML = `<i class="fas fa-chevron-left"></i>`; prevButton.className = 'pagination-button'; prevButton.disabled = currentPage === 1; prevButton.addEventListener('click', () => { if (currentPage > 1) { currentPage--; loadAndDisplayCekimler(); } }); paginationControlsEl.appendChild(prevButton);
        for (let i = 1; i <= pageCount; i++) { const btn = document.createElement('button'); btn.innerText = i; btn.className = 'pagination-button'; if (i === currentPage) btn.classList.add('active'); btn.addEventListener('click', () => { currentPage = i; loadAndDisplayCekimler(); }); paginationControlsEl.appendChild(btn); }
        const nextButton = document.createElement('button'); nextButton.innerHTML = `<i class="fas fa-chevron-right"></i>`; nextButton.className = 'pagination-button'; nextButton.disabled = currentPage === pageCount; nextButton.addEventListener('click', () => { if (currentPage < pageCount) { currentPage++; loadAndDisplayCekimler(); } }); paginationControlsEl.appendChild(nextButton);
    }

    async function populateFormById(id) {
        const kayit = allCekimler.find(k => k.id == id);
        if (kayit) {
            editingIdInput.value = kayit.id;
            Object.keys(cekForm.elements).forEach(key => {
                const element = cekForm.elements[key];
                if(element.name && kayit[element.name] !== undefined) {
                     updateSelectDisplay(element, kayit[element.name]);
                }
            });
            document.getElementById('akademik-izleme-notu').value = (kayit.akademikIzlemeNotu && kayit.akademikIzlemeNotu.content) ? kayit.akademikIzlemeNotu.content : '';
            document.getElementById('form-container').scrollIntoView({ behavior: 'smooth' });
        }
    }

    cekForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const id = editingIdInput.value;
        if (!id) { showNotification("Lütfen düzenlemek için bir kayıt seçin.", "error"); return; }
        
        const formData = new FormData(cekForm);
        const data = {};
        for (let [key, value] of formData.entries()) {
            if (key === 'kazanimKodu') {
                if (!data[key]) data[key] = [];
                data[key].push(value);
            } else {
                data[key] = value || null;
            }
        }
        if (!data.kazanimKodu) data.kazanimKodu = [];

        const { error } = await supabaseClient.from('cekimler').update(data).eq('id', id);
        if (error) { showNotification('Akademik bilgiler güncellenirken hata: ' + error.message, 'error'); } 
        else { showNotification('Tüm akademik bilgiler güncellendi!'); await loadAndDisplayCekimler(); }
    });

    kaydetNotuBtn.addEventListener('click', async () => {
        const id = editingIdInput.value;
        if (!id) { showNotification("Notu kaydetmek için önce listeden bir kayıt seçmelisiniz.", "error"); return; }
        const notIcerigi = document.getElementById('akademik-izleme-notu').value;
        if (!notIcerigi.trim()) { showNotification("Not alanı boş bırakılamaz.", "error"); return; }
        
        const kayit = allCekimler.find(k => k.id == id);
        if (!kayit) return;

        const dosyaAdi = `akademik_not_${kayit.videoKodu || kayit.id}.txt`;
        const akademikIzlemeNotuObjesi = { fileName: dosyaAdi, content: notIcerigi };
        
        const { error } = await supabaseClient.from('cekimler').update({ akademikIzlemeNotu: akademikIzlemeNotuObjesi }).eq('id', id);
        if (error) { showNotification("Not kaydedilirken hata: " + error.message, "error"); } 
        else {
            const blob = new Blob([notIcerigi], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = dosyaAdi;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('Akademik not kaydedildi ve indirildi!');
            await loadAndDisplayCekimler();
        }
    });
    
    tableBody.addEventListener('click', function(e) {
        const toggleIcon = e.target.closest('.group-toggle-icon');
        if (toggleIcon) {
            e.stopPropagation();
            const group = toggleIcon.dataset.group;
            const children = tableBody.querySelectorAll(`.group-child[data-group="${group}"]`);
            children.forEach(child => {
                child.style.display = child.style.display === 'table-row' ? 'none' : 'table-row';
            });
            toggleIcon.classList.toggle('expanded');
            updateCollapsibleHeight(document.querySelector('#cekim-tablosu').closest('.collapsible-content'));
            return;
        }

        const clickedRow = e.target.closest('tr');
        if (clickedRow && !e.target.closest('button')) {
            const currentlySelected = tableBody.querySelector('.satir-secili');
            if (currentlySelected) { currentlySelected.classList.remove('satir-secili'); }
            clickedRow.classList.add('satir-secili');
        }

        const editButton = e.target.closest('.edit-row');
        const downloadNoteButton = e.target.closest('.download-note-btn');
        const viewAkademikBtn = e.target.closest('.view-akademik-btn');

        if (viewAkademikBtn) { e.preventDefault(); const id = viewAkademikBtn.dataset.id; populateFormById(id); }
        if (editButton) { e.preventDefault(); const id = editButton.closest('tr').dataset.id; populateFormById(id); }
        if (downloadNoteButton) { e.preventDefault(); const id = downloadNoteButton.dataset.id; const kayit = allCekimler.find(k => k.id === id); if (kayit && kayit.akademikIzlemeNotu && kayit.akademikIzlemeNotu.content) { const blob = new Blob([kayit.akademikIzlemeNotu.content], { type: 'text/plain;charset=utf-8' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = kayit.akademikIzlemeNotu.fileName || 'akademik_not.txt'; document.body.appendChild(link); link.click(); document.body.removeChild(link); } }
    });
    
    document.querySelectorAll('.filter-input').forEach(input => {
        input.addEventListener('keyup', () => { currentPage = 1; loadAndDisplayCekimler(); });
    });
    document.addEventListener('click', () => { document.querySelectorAll('.custom-select-dropdown').forEach(d => d.classList.add('hidden')); });

    async function initializePage() {
        populateSelect('akademik-izleme-ogretmeni', akademikIzlemeOgretmenleri);
        populateSelect('kazanim-kodu', kazanimKodlari);
        
        ['akademik-izleme-ogretmeni', 'akademik-izleme-durumu', 'zorluk-derecesi'].forEach(id => {
            const selectElement = document.getElementById(id);
            if (selectElement) createSearchableDropdown(selectElement);
        });

        const multiSelect = document.getElementById('kazanim-kodu');
        if(multiSelect) createMultiSelectDropdown(multiSelect);

        await loadAndDisplayCekimler();

        const selectedId = localStorage.getItem('selectedCekimId');
        if (selectedId) {
            setTimeout(async () => {
                await populateFormById(selectedId);
                localStorage.removeItem('selectedCekimId');
            }, 300); 
        }

        // DÜZELTME: Panelleri her durumda açık başlat
        setTimeout(() => {
            document.querySelectorAll('.collapsible-trigger').forEach(trigger => {
                const content = trigger.nextElementSibling;
                const icon = trigger.querySelector('i:last-child');
                if (content && icon) {
                    content.style.maxHeight = content.scrollHeight + "px";
                    icon.classList.add('rotate-180');
                }
            });
        }, 200);
    }

    initializePage();
});
</script>

</body>
</html>
